---
title: "Process_Data_v3"
author: "czx"
date: "`r Sys.Date()`"
output: html_document
---

# Process Coding
## Loading package
```{r Package, warning = FALSE,message = FALSE}
## åŠ è½½å¿…è¦çš„ R åŒ…
library(tidyr)
library(dplyr)
library(stringr)
library(effsize)
library(here)
library(pwr)
library(ggplot2)
```

# Read csv (åŒºåˆ†å…¬å¼€å’Œæœªå…¬å¼€) [åŒ…å«æ²¡æœ‰Trialè®°å½•çš„]
```{r}
library(dplyr)
library(readr)

## è®¾ç½®æ•°æ®è·¯å¾„
dataPath <- "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = ".*_Clean\\.csv$", full.names = TRUE, recursive = TRUE)

## éœ€è¦æ’é™¤çš„æ–‡ä»¶å¤¹
exclude_folders <- c("Bukowski_2021_AP", "Golubickis_2021_AP", 
                     "Hobbs_2023_PM", "Mcivor_2020_EJN", 
                     "Orellana-Corrales_2021_EP", "Svensson_2021_PR", 
                     "Wang_2016_EPHPP","Liang_2022_HBM","Hobbs_2021_PM",
                     "Lee_2023_Cognition","Orellana-Corrales_2021_APP",
                     "Kirk_2025_BJP","Svensson_2023_QJEP")

## è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
data_files <- data_files[!grepl(paste(exclude_folders, collapse = "|"), data_files)]

## é¢„åˆ†é…å­˜å‚¨å˜é‡ï¼ˆåˆ—è¡¨å­˜å‚¨æ•°æ®ï¼‰
results_list <- list()

## è®¡æ•°å™¨
counter <- 1

## è¯»å– CSV æ–‡ä»¶å¹¶å¤„ç†æ•°æ®
for (i in seq_along(data_files)) {
  file_name <- basename(data_files[i])  # æå–æ–‡ä»¶åï¼ˆå‡è®¾æ–‡ä»¶åä»£è¡¨æ–‡ç« åç§°ï¼‰
  
  Data <- read_csv(data_files[i], show_col_types = FALSE) %>%
    mutate(across(where(is.character), as.character))  # ç¡®ä¿å­—ç¬¦å˜é‡ç±»å‹ä¸€è‡´
  
  # ç¡®ä¿æ•°æ®åŒ…å«æ‰€éœ€å˜é‡
  if (all(c("RT_ms", "ACC", "Label", "Standarlized_Identity", "Subject", "Matching") %in% names(Data))) {
    
    # ç”Ÿæˆå”¯ä¸€æ ‡è¯†æ¯ç¯‡æ–‡ç« çš„ Subject IDï¼Œå¹¶æ·»åŠ  Source å˜é‡
    Data <- Data %>%
      mutate(
        Subject = paste0(file_name, "_", Subject),
        Source = file_name  # **æ–°å¢å˜é‡ï¼Œæ ‡è®°æ¥æºæ–‡ç« **
      )
    
    # è¿‡æ»¤ RT åœ¨åˆç†èŒƒå›´å†…çš„è¡Œ
    Data <- Data %>%
      filter(RT_ms > 200 & RT_ms < 5000, ACC %in% c(0, 1))  # è¿‡æ»¤å¼‚å¸¸å€¼

    # **å­˜å…¥åˆ—è¡¨**
    results_list[[counter]] <- Data %>%
      select(Source, Subject, Matching, Label, Standarlized_Identity, RT_ms, ACC)  # **ä¿ç•™ Source å˜é‡**
    
    counter <- counter + 1
  }
  print(paste('å®Œæˆæ•°æ®é›†', i, 'å¤„ç†'))
}

# **åˆå¹¶æ‰€æœ‰æ•°æ®**
results <- bind_rows(results_list)

# **æ£€æŸ¥åˆå¹¶åçš„æ•°æ®**
print("æ•°æ®å¤„ç†å®Œæˆï¼Œå·²å­˜å…¥ `results` å˜é‡")

# **è¾“å‡ºæ•°æ®åˆ° CSV**
# write.csv(results, "Processed_Data.csv", row.names = FALSE)

save(df,results,results_list,file = "Share_Data.RData", compress = TRUE)
load("Share_Data.RData")
```

```{r}
library(dplyr)
library(readr)

## è®¾ç½®æ•°æ®è·¯å¾„
dataPath <- "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = ".*_Clean\\.csv$", full.names = TRUE, recursive = TRUE)

## éœ€è¦æ’é™¤çš„æ–‡ä»¶å¤¹
exclude_folders <- c("Bukowski_2021_AP", "Golubickis_2021_AP", 
                     "Hobbs_2023_PM", "Mcivor_2020_EJN", 
                     "Orellana-Corrales_2021_EP", "Svensson_2021_PR", 
                     "Wang_2016_EPHPP","Liang_2022_HBM","Hobbs_2021_PM",
                     "Lee_2023_Cognition","Orellana-Corrales_2021_APP",
                     "Kirk_2025_BJP","Svensson_2023_QJEP","Sun_2025","Pan_2025")

## è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
data_files <- data_files[!grepl(paste(exclude_folders, collapse = "|"), data_files)]

## é¢„åˆ†é…å­˜å‚¨å˜é‡ï¼ˆåˆ—è¡¨å­˜å‚¨æ•°æ®ï¼‰
results_list <- list()

## è®¡æ•°å™¨
counter <- 1

## è¯»å– CSV æ–‡ä»¶å¹¶å¤„ç†æ•°æ®
for (i in seq_along(data_files)) {
  file_name <- basename(data_files[i])  # æå–æ–‡ä»¶åï¼ˆå‡è®¾æ–‡ä»¶åä»£è¡¨æ–‡ç« åç§°ï¼‰
  
  Data <- read_csv(data_files[i], show_col_types = FALSE) %>%
    mutate(across(where(is.character), as.character))  # ç¡®ä¿å­—ç¬¦å˜é‡ç±»å‹ä¸€è‡´
  
  # ç¡®ä¿æ•°æ®åŒ…å«æ‰€éœ€å˜é‡
  if (all(c("RT_ms", "ACC", "Standarlized_Identity", "Subject", "Matching") %in% names(Data))) {
    
    # ç”Ÿæˆå”¯ä¸€æ ‡è¯†æ¯ç¯‡æ–‡ç« çš„ Subject IDï¼Œå¹¶æ·»åŠ  Source å˜é‡
    Data <- Data %>%
      mutate(
        Subject = paste0(file_name, "_", Subject),
        Source = file_name  # **æ–°å¢å˜é‡ï¼Œæ ‡è®°æ¥æºæ–‡ç« **
      )
    
    # è¿‡æ»¤ RT åœ¨åˆç†èŒƒå›´å†…çš„è¡Œ
    Data <- Data %>%
      filter(RT_ms > 200 & RT_ms < 5000, ACC %in% c(0, 1))  # è¿‡æ»¤å¼‚å¸¸å€¼

    # **å­˜å…¥åˆ—è¡¨**
    results_list[[counter]] <- Data %>%
      select(Source, Subject, Matching, Standarlized_Identity, RT_ms, ACC)  # **ä¿ç•™ Source å˜é‡**
    
    counter <- counter + 1
  }
  print(paste('å®Œæˆæ•°æ®é›†', i, 'å¤„ç†'))
}

# **åˆå¹¶æ‰€æœ‰æ•°æ®**
results <- bind_rows(results_list)

# æ’é™¤è¢«è¯•å­˜åœ¨æŸä¸ªIdentityæ­£ç¡®ç‡ä½äº50%
subjects_to_exclude <- results %>%
  group_by(Subject, Standarlized_Identity) %>%
  summarise(mean_acc = mean(ACC, na.rm = TRUE), .groups = "drop") %>%
  filter(mean_acc < 0.50) %>%  # ä¿®æ”¹ä¸º50%é˜ˆå€¼
  distinct(Subject)

# æ’é™¤è¿™äº›è¢«è¯•
results_filtered <- results %>%
  anti_join(subjects_to_exclude, by = "Subject")

# **æ£€æŸ¥åˆå¹¶åçš„æ•°æ®**
print("æ•°æ®å¤„ç†å®Œæˆï¼Œå·²å­˜å…¥ `results_filtered` å˜é‡")

# **è¾“å‡ºæ•°æ®åˆ° CSV**
write.csv(results_filtered, "Processed_Data_Filtered.csv", row.names = FALSE)
```

```{r}
library(dplyr)
library(readr)

## è®¾ç½®æ•°æ®è·¯å¾„
dataPath <- "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = ".*_Clean\\.csv$", full.names = TRUE, recursive = TRUE)

## éœ€è¦æ’é™¤çš„æ–‡ä»¶å¤¹
exclude_folders <- c("Bukowski_2021_AP", "Golubickis_2021_AP", 
                     "Hobbs_2023_PM", "Mcivor_2020_EJN", 
                     "Orellana-Corrales_2021_EP", "Svensson_2021_PR", 
                     "Wang_2016_EPHPP","Liang_2022_HBM","Hobbs_2021_PM",
                     "Lee_2023_Cognition","Orellana-Corrales_2021_APP",
                     "Kirk_2025_BJP","Svensson_2023_QJEP")

## è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
data_files <- data_files[!grepl(paste(exclude_folders, collapse = "|"), data_files)]

## é¢„åˆ†é…å­˜å‚¨å˜é‡ï¼ˆåˆ—è¡¨å­˜å‚¨æ•°æ®ï¼‰
results_list <- list()

## è¯»å– CSV æ–‡ä»¶å¹¶å¤„ç†æ•°æ®
for (i in seq_along(data_files)) {
  file_name <- basename(data_files[i])
  
  # è¯»å–æ—¶æŒ‡å®šåˆ—ç±»å‹ï¼Œç¡®ä¿ Label åˆ—ä¸ºå­—ç¬¦å‹
  Data <- read_csv(data_files[i], show_col_types = FALSE,
                   col_types = cols(Label = col_character())) %>%
    mutate(across(where(is.character), as.character))
  
  # ç¡®ä¿æ•°æ®åŒ…å«æ‰€éœ€å˜é‡
  required_cols <- c("RT_ms", "ACC", "Label_Identity", "Standarlized_Identity", "Subject", "Matching")
  if (all(required_cols %in% names(Data))) {
    
    Data <- Data %>%
      mutate(
        Subject = paste0(file_name, "_", Subject),
        Source = file_name
      ) %>%
      filter(RT_ms > 200 & RT_ms < 5000, ACC %in% c(0, 1)) %>%
      select(Source, Subject, Matching, Label_Identity, Standarlized_Identity, RT_ms, ACC)
    
    results_list[[length(results_list) + 1]] <- Data
  }
  print(paste('å®Œæˆæ•°æ®é›†', i, 'å¤„ç†'))
}

# åˆå¹¶æ‰€æœ‰æ•°æ®
results <- bind_rows(results_list)

# æ£€æŸ¥åˆå¹¶åçš„æ•°æ®
glimpse(results)

# ä¿å­˜æ•°æ®
save(results, results_list, file = "Share_Data.RData")

# **è¾“å‡ºæ•°æ®åˆ° CSV**
write.csv(results, "Processed_Data.csv", row.names = FALSE)
```

```{r}
library(dplyr)
library(readr)

## è®¾ç½®æ•°æ®è·¯å¾„
dataPath <- "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = ".*_Clean\\.csv$", full.names = TRUE, recursive = TRUE)

## éœ€è¦æ’é™¤çš„æ–‡ä»¶å¤¹
exclude_folders <- c("Bukowski_2021_AP", "Golubickis_2021_AP", 
                     "Hobbs_2023_PM", "Mcivor_2020_EJN", 
                     "Orellana-Corrales_2021_EP", "Svensson_2021_PR", 
                     "Wang_2016_EPHPP","Liang_2022_HBM","Hobbs_2021_PM",
                     "Lee_2023_Cognition","Orellana-Corrales_2021_APP",
                     "Kirk_2025_BJP","Svensson_2023_QJEP")

## è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
data_files <- data_files[!grepl(paste(exclude_folders, collapse = "|"), data_files)]

## é¢„åˆ†é…å­˜å‚¨å˜é‡ï¼ˆåˆ—è¡¨å­˜å‚¨æ•°æ®ï¼‰
results_list <- list()

## è¯»å– CSV æ–‡ä»¶å¹¶å¤„ç†æ•°æ®
for (i in seq_along(data_files)) {
  file_name <- basename(data_files[i])
  
  # è¯»å–æ—¶æŒ‡å®šåˆ—ç±»å‹ï¼Œç¡®ä¿ Label åˆ—ä¸ºå­—ç¬¦å‹
  Data <- read_csv(data_files[i], show_col_types = FALSE,
                   col_types = cols(Label = col_character())) %>% 
    mutate(across(where(is.character), as.character))
  
  # ç¡®ä¿æ•°æ®åŒ…å«æ‰€éœ€å˜é‡
  required_cols <- c("RT_ms", "ACC", "Label", "Standarlized_Identity", "Subject", "Matching")
  if (all(required_cols %in% names(Data))) {
    
    # æ·»åŠ  Label_Identity åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™ç”¨ NA å¡«å……ï¼‰
    if (!"Label_Identity" %in% names(Data)) {
      Data$Label_Identity <- NA_character_
    }
    
    Data <- Data %>%
      mutate(
        Subject = paste0(file_name, "_", Subject),
        Source = file_name
      ) %>%
      filter(RT_ms > 200 & RT_ms < 5000, ACC %in% c(0, 1)) %>%
      select(Source, Subject, Matching, Label, Label_Identity, Standarlized_Identity, RT_ms, ACC)
    
    results_list[[length(results_list) + 1]] <- Data
  }
  print(paste('å®Œæˆæ•°æ®é›†', i, 'å¤„ç†'))
}

# åˆå¹¶æ‰€æœ‰æ•°æ®
results <- bind_rows(results_list)

# **è¾“å‡ºæ•°æ®åˆ° CSV**
write.csv(results, "Processed_Data.csv", row.names = FALSE)

# æ£€æŸ¥åˆå¹¶åçš„æ•°æ®
glimpse(results)

# ä¿å­˜æ•°æ®
save(results, results_list, file = "Share_Data.RData")
```



# è®ºæ–‡æ•°é‡ã€å®éªŒæ•°é‡ã€è¢«è¯•æ•°
```{r}
library(dplyr)
library(readr)
library(stringr)

# è¯»å–å·²å¤„ç†çš„æ•°æ®
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)
# data <- read_csv("Processed_Data_for_SDE.csv", show_col_types = FALSE)
#data <- read_csv("Processed_Data.csv", show_col_types = FALSE)

# å¤„ç† Source å˜é‡ï¼Œæå–æ–‡ç« ä¿¡æ¯ï¼ˆæ”¯æŒä¸¤ç§æ ¼å¼ï¼‰
data <- data %>%
  mutate(
    Article = case_when(
      str_detect(Source, "^[^_]+_\\d{4}_[^_]+_Exp\\d+") ~ str_extract(Source, "^[^_]+_\\d{4}_[^_]+"),  # å‘è¡¨çš„æ ¼å¼
      str_detect(Source, "^[^_]+_\\d{4}_Exp\\d+") ~ str_extract(Source, "^[^_]+_\\d{4}")  # æœªå‘è¡¨çš„æ ¼å¼
    ),
    Experiment = str_extract(Source, "Exp\\d+"),  # æå–å®éªŒç¼–å·
    Subject_ID = str_extract(Subject, "[^_]+$")  # æå–è¢«è¯•ç¼–å·
  )

# ç»Ÿè®¡æ–‡ç« ã€å®éªŒã€è¢«è¯•æ•°é‡
summary_table <- data %>%
  group_by(Article, Experiment) %>%
  summarise(Num_Subjects = n_distinct(Subject_ID), .groups = "drop") %>%
  arrange(Article, Experiment)

# ç»Ÿè®¡æ¯ç¯‡æ–‡ç« çš„å®éªŒæ•°
article_summary <- summary_table %>%
  group_by(Article) %>%
  summarise(Num_Experiments = n_distinct(Experiment), Total_Subjects = sum(Num_Subjects), .groups = "drop")

# è¾“å‡ºç»“æœ
write.csv(summary_table, "Experiment_Summary.csv", row.names = FALSE)
write.csv(article_summary, "Article_Summary.csv", row.names = FALSE)

# æ‰“å°æ‘˜è¦ä¿¡æ¯
print("å®éªŒç»Ÿè®¡å®Œæˆï¼Œå·²è¾“å‡ºä»¥ä¸‹æ–‡ä»¶ï¼š")
print("- Experiment_Summary.csvï¼ˆæ¯ç¯‡æ–‡ç« çš„å®éªŒåŠè¢«è¯•æ•°é‡ï¼‰")
print("- Article_Summary.csvï¼ˆæ¯ç¯‡æ–‡ç« çš„å®éªŒæ•°å’Œæ€»è¢«è¯•æ•°ï¼‰")

```

# è®ºæ–‡æ•°é‡ã€å®éªŒæ•°é‡ã€è¢«è¯•æ•°_v2
```{r}
library(dplyr)
library(readr)
library(stringr)

# è¯»å–å·²å¤„ç†çš„æ•°æ®
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

# å¤„ç† Source å˜é‡ï¼Œæå–æ–‡ç« ã€å®éªŒç¼–å·ã€è¢«è¯•ID
data <- data %>%
  mutate(
    Article = case_when(
      str_detect(Source, "^[^_]+_\\d{4}_[^_]+_Exp\\d+") ~ str_extract(Source, "^[^_]+_\\d{4}_[^_]+"),
      str_detect(Source, "^[^_]+_\\d{4}_Exp\\d+") ~ str_extract(Source, "^[^_]+_\\d{4}")
    ),
    Experiment = str_extract(Source, "Exp\\d+"),
    Subject_ID = str_extract(Subject, "[^_]+$")
  )

# === 1. è¾“å‡ºæ¯ä¸ªè¢«è¯•ä¸€è¡Œçš„ä¿¡æ¯ ===
subject_info <- data %>%
  select(Source, Subject, Age, Gender) %>%
  distinct() %>%
  arrange(Source, Subject)

write_csv(subject_info, "Subject_information.csv")

# === 2. ç»Ÿè®¡æ¯ä¸ªå®éªŒçš„è¢«è¯•æ•°é‡ ===
summary_table <- data %>%
  group_by(Article, Experiment) %>%
  summarise(Num_Subjects = n_distinct(Subject_ID), .groups = "drop") %>%
  arrange(Article, Experiment)

write_csv(summary_table, "Experiment_Summary.csv")

# === 3. ç»Ÿè®¡æ¯ç¯‡æ–‡ç« çš„å®éªŒæ•° & æ€»è¢«è¯•æ•° ===
article_summary <- summary_table %>%
  group_by(Article) %>%
  summarise(Num_Experiments = n_distinct(Experiment),
            Total_Subjects = sum(Num_Subjects),
            .groups = "drop")

write_csv(article_summary, "Article_Summary.csv")
```

## å¹´é¾„
```{r}
# 1. å¹´é¾„åˆ†å¸ƒç›´æ–¹å›¾
p1 <- ggplot(subject_info, aes(x = Age)) +
  geom_histogram(binwidth = 2, fill = "#69b3a2", color = "black", boundary = 0) +
  theme_classic(base_size = 14) +
  labs(title = "Age Distribution", x = "Age", y = "Count")
  p1
```

## æ€§åˆ«
```{r}
# 2. æ€§åˆ«æ¯”ä¾‹æ¡å½¢å›¾
p2 <- df %>%
  count(Gender) %>%
  ggplot(aes(x = Gender, y = n, fill = Gender)) +
  geom_bar(stat = "identity", color = "black") +
  theme_classic(base_size = 14) +
  scale_fill_manual(values = c("#FF9999", "#99CCFF", "#BBBBBB")) +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  theme(legend.position = "none")
  p2
```

```{r}
library(ggplot2)
library(dplyr)
# è¯»å–è¢«è¯•ä¿¡æ¯
df <- read.csv("Subject_information.csv")

# æ±‡æ€»æ€§åˆ«æ•°é‡
gender_summary <- df %>%
  filter(!is.na(Gender)) %>%
  group_by(Gender) %>%
  summarise(Count = n()) %>%
  mutate(Percent = Count / sum(Count) * 100,
         Label = paste0(Gender, "\n", round(Percent, 1), "%"))

ggplot(gender_summary, aes(x = "", y = Count, fill = Gender)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  theme_void(base_size = 14) +
  geom_text(aes(label = Label), position = position_stack(vjust = 0.5), size = 5) +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62", "#8da0cb")) +  # è‡ªå®šä¹‰é¢œè‰²
  labs(title = "Gender Distribution of Participants") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))


```


## Stim Type
```{r}
library(ggplot2)
library(dplyr)
df_info <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

df_info %>%
  count(Stim_Type) %>%
  ggplot(aes(x = reorder(Stim_Type, n), y = n)) +
  geom_bar(stat = "identity", fill = "#66c2a5") +
  coord_flip() +
  theme_minimal(base_size = 14) +
  labs(title = "Stimulus Types in SPE Studies", x = "Stimulus Type", y = "Number of Studies")
```

```{r}
library(ggplot2)
library(dplyr)
library(readr)

# 1. è¯»å–æ•°æ®
df <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

# 2. ç»Ÿè®¡ Stim_Type æ•°é‡
stim_summary <- df %>%
  filter(!is.na(Stim_Type)) %>%
  group_by(Stim_Type) %>%
  summarise(Count = n()) %>%
  mutate(Percent = Count / sum(Count) * 100,
         Label = paste0(Stim_Type, "\n", round(Percent, 1), "%"))

# 3. ç»˜åˆ¶é¥¼å›¾
ggplot(stim_summary, aes(x = "", y = Count, fill = Stim_Type)) +
  geom_col(width = 1, color = "white") +
  scale_fill_manual(values = c(
  "#fc8d62", "#66c2a5",  "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f"
)) +
  coord_polar(theta = "y") +
  theme_void(base_size = 14) +
  #geom_text(aes(label = Label), position = position_stack(vjust = 0.5), size = 4.5) +
  #scale_fill_brewer(palette = "Pastel1") +
  labs(title = "Stimulus Type Distribution in SPE Studies") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

```{r}
library(ggplot2)
library(dplyr)
library(readr)

# 1. è¯»å–æ•°æ®
df <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

# 2. ç»Ÿè®¡ Stim_Type æ•°é‡
stim_summary <- df %>%
  filter(!is.na(Stim_Type)) %>%
  group_by(Stim_Type) %>%
  summarise(Count = n()) %>%
  mutate(
    Percent = Count / sum(Count) * 100,
    Stim_Type = factor(Stim_Type),  # ä¿æŒåŸå§‹é¡ºåº
    Label = paste0(round(Percent, 1), "%")
  )

# 3. ç»˜åˆ¶ Poster é£æ ¼çš„ç¯å½¢é¥¼å›¾ï¼ˆä¸åœ¨å›¾ä¸­æ˜¾ç¤º Stim_Typeï¼‰
ggplot(stim_summary, aes(x = 2, y = Count, fill = Stim_Type)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  xlim(0.5, 2.5) +  # ç¯å½¢å›¾æ•ˆæœ
  theme_void(base_size = 14) +
  scale_fill_manual(values = c(
  "#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f"
)) +  # âœ… ä½ çš„é¢œè‰²æ–¹æ¡ˆ
  labs(
    title = "Stimulus Type Distribution in SPE Studies",
    subtitle = "Across all experiments",
    fill = "Stimulus Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 12),
    legend.position = "right"
  )


```

```{r}
# åŠ è½½åŒ…
library(ggplot2)
library(dplyr)
library(readr)
library(treemapify)

# è¯»å–æ•°æ®
df <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

# ç»Ÿè®¡ Stim_Type æ•°é‡
stim_summary <- df %>%
  filter(!is.na(Stim_Type)) %>%
  group_by(Stim_Type) %>%
  summarise(Count = n()) %>%
  mutate(
    Percent = Count / sum(Count) * 100,
    Label = paste0(Stim_Type, "\n", Count)
  )

# è‡ªå®šä¹‰é¢œè‰²ï¼ˆä½ å¯ä»¥æ”¹æˆæ›´åˆé€‚çš„é¢œè‰²æ­é…ï¼‰
custom_colors <- c(
  "#66c2a5", "#00CC99", "#8da0cb", "#e78ac3", "#a6d854", "#336B87"
)

# ç»˜åˆ¶ Treemap
ggplot(stim_summary, aes(
  area = Count,
  fill = Stim_Type,
  label = Label
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre",
    grow = TRUE,
    colour = "white",
    fontface = "bold",
    reflow = TRUE
  ) +
  scale_fill_manual(values = custom_colors) +
  labs(title = "Stimulus Type Distribution in SPE Studies") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16)
  )

```
#### Treemap
```{r}
# åŠ è½½åŒ…
library(ggplot2)
library(dplyr)
library(readr)
library(treemapify)

# è¯»å–æ•°æ®
df <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

# ç»Ÿè®¡ Stim_Type æ•°é‡
stim_summary <- df %>%
  filter(!is.na(Stim_Type)) %>%
  group_by(Stim_Type) %>%
  summarise(Count = n()) %>%
  mutate(
    Percent = Count / sum(Count) * 100,
    Label = paste0(Stim_Type, "\n", Count)
  )

# âœ… è‡ªå®šä¹‰é…è‰²æ–¹æ¡ˆï¼ŒåŸºäº Poster ä¸»è‰² RGB(0,204,153) = "#00CC99"
custom_colors <- c(
  "#00CC99",  # ä¸»è‰²ï¼ˆé’ç»¿è‰²ï¼‰
  "#00997A",  # æ·±é’
  "#66E0C4",  # æµ…é’
  "#336B87",  # æ·±è“
  "#A0A0A0",  # ä¸­ç°
  "#8da0cb"   # ç±³ç™½
)

# å¦‚æœ Stim_Type è¶…è¿‡ 6 ç±»ï¼Œä½ å¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼æ‰©å±•é¢œè‰²å‘é‡
# custom_colors <- rep(custom_colors, length.out = nrow(stim_summary))

# ç»˜å›¾
ggplot(stim_summary, aes(
  area = Count,
  fill = Stim_Type,
  label = Label
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre",
    grow = TRUE,
    colour = "white",
    fontface = "bold",
    reflow = TRUE
  ) +
  scale_fill_manual(values = custom_colors) +
  labs(title = "Stimulus Type Distribution in SPE Studies") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.background = element_rect(fill = "white", color = NA)
  )

```


```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(treemapify)

# è¯»å–æ•°æ®
df <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

# âœ… æ•°æ®æ¸…ç†ï¼šæ¯ä¸ª Paper åªä¿ç•™ä¸€ä¸ª Stim_Type ç»„åˆï¼Œé¿å…é‡å¤
df_clean <- df %>%
  filter(!is.na(Stim_Type)) %>%
  distinct(Paper_ID, Stim_Type, .keep_all = TRUE)

# ç»Ÿè®¡æ¯ç§ Stim_Type çš„å”¯ä¸€æ•°é‡
stim_summary <- df_clean %>%
  group_by(Stim_Type) %>%
  summarise(Count = n()) %>%
  mutate(
    Label = paste0(Stim_Type, "\n", Count),
    # è‡ªåŠ¨å­—ä½“é¢œè‰²ï¼ˆCount é«˜ â†’ ç™½è‰²ï¼Œä½ â†’ é»‘è‰²ï¼‰
    TextColor = ifelse(Count > median(Count), "white", "black")
  )

# ç»˜å›¾
ggplot(stim_summary, aes(
  area = Count,
  fill = Count
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    aes(label = Label, colour = TextColor),
    place = "centre",
    grow = TRUE,
    fontface = "bold",
    reflow = TRUE
  ) +
  scale_fill_gradient(
    low = "#E0F7EF",  # æµ…ç»¿
    high = "#00CC99", # ä¸»è‰²
    name = "Stimulus\nFrequency"
  ) +
  scale_colour_identity() +
  labs(title = "Stimulus Type Distribution (Unique per Paper)") +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.background = element_rect(fill = "white", color = NA)
  )

```

```{r}
# åŠ è½½åŒ…
library(ggplot2)
library(dplyr)
library(readr)
library(treemapify)

# è¯»å–æ•°æ®
df <- read_csv("Dataset_inf.csv", show_col_types = FALSE)

# ç»Ÿè®¡ Stim_Type æ•°é‡å¹¶æŒ‰æ•°é‡æ’åº
stim_summary <- df %>%
  filter(!is.na(Stim_Type)) %>%
  group_by(Stim_Type) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  mutate(
    Percent = Count / sum(Count) * 100,
    Label = paste0(Stim_Type, "\n", Count)
  )

# è‡ªå®šä¹‰é…è‰²æ–¹æ¡ˆ
custom_colors <- c(
  "#00CC99",  # ä¸»è‰²ï¼ˆé’ç»¿è‰²ï¼‰
  "#00997A",  # æ·±é’
  "#66E0C4",  # æµ…é’
  "#336B87",  # æ·±è“
  "#8da0cb",  # æ·¡è“
  "#A0A0A0"   # ä¸­ç°

)
# è‡ªåŠ¨æ‰©å±•é¢œè‰²æ•°é‡
custom_colors <- rep(custom_colors, length.out = nrow(stim_summary))

# è®¾ç½® factor é¡ºåºï¼Œç¡®ä¿é¢œè‰²åŒ¹é…
stim_summary$Stim_Type <- factor(stim_summary$Stim_Type, levels = stim_summary$Stim_Type)

# åˆ›å»ºå›¾å½¢å¯¹è±¡
p <- ggplot(stim_summary, aes(
  area = Count,
  fill = Stim_Type,
  label = Label
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre",
    grow = TRUE,
    colour = "white",
    fontface = "bold",
    reflow = TRUE
  ) +
  scale_fill_manual(values = custom_colors) +
  labs(title = "Stimulus Type Distribution in SPE Studies") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.background = element_rect(fill = "white", color = NA)
  )

# æ˜¾ç¤ºå›¾å½¢
print(p)

# âœ… ä¿å­˜ä¸º300dpi PNGæ–‡ä»¶ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆPDFã€TIFFï¼‰
ggsave(
  filename = "Stimulus_Type_Treemap.png",
  plot = p,
  width = 8,
  height = 6,
  dpi = 300
)


```


## ä¸–ç•Œåœ°å›¾
```{r}
library(dplyr)
library(ggplot2)
library(tidygeocoder)
library(readr)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(stringi)
library(stringr)   # ğŸ‘ˆ åŠ ä¸Šè¿™ä¸ªï¼

# è¯»å–æ•°æ®å¹¶å¼ºåˆ¶ä½¿ç”¨ UTF-8
df <- read_csv("Dataset_inf.csv", locale = locale(encoding = "UTF-8"), show_col_types = FALSE)

# æ¸…æ´— Country å’Œ City å­—æ®µ
df_clean <- df %>%
  filter(!is.na(Country), !is.na(City)) %>%
  mutate(
    Country = stri_trans_general(Country, "Latin-ASCII"),
    City = stri_trans_general(City, "Latin-ASCII"),
    City = str_replace_all(City, "[^[:alnum:][:space:]]", ""),  # ğŸ’¡ æ­¤å¤„éœ€è¦ stringr
    full_address = paste(City, Country, sep = ", ")
  ) %>%
  distinct(full_address, .keep_all = TRUE)

# åœ°ç†ç¼–ç 
df_geo <- df_clean %>%
  geocode(address = full_address, method = "arcgis", lat = latitude, long = longitude)


# ä¸–ç•Œåœ°å›¾
world <- ne_countries(scale = "medium", returnclass = "sf")

# å¯è§†åŒ–
ggplot(data = world) +
  geom_sf(fill = "gray95", color = "white") +
  geom_point(data = df_geo, 
             aes(x = longitude, y = latitude), 
             color = "#1f78b4", size = 3, alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(title = "Global Distribution of SPE Studies",
       subtitle = "Each point represents a study site",
       x = NULL, y = NULL) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5)
  )

```


## Pic1
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(Hmisc)
library(plyr)
library(RColorBrewer)
library(reshape2)

# è¯»å–æ•°æ®
data <- read.csv("Processed_Data.csv")

# é‡æ–°å‘½ååˆ—ä»¥åŒ¹é…éœ€æ±‚
colnames(data) <- c("rt_self", "rt_close", "rt_stranger", "rt_non_person", "rt_acquaintance", 
                    "cohens_d_self_close", "cohens_d_self_stranger", "cohens_d_self_non_person", "cohens_d_self_acquaintance")

# è®¡ç®— RT å·®å€¼
data$SA_RT <- data$rt_self - data$rt_acquaintance
data$SC_RT <- data$rt_self - data$rt_close
data$SS_RT <- data$rt_self - data$rt_stranger
data$SN_RT <- data$rt_self - data$rt_non_person

# å®šä¹‰ geom_flat_violin
"%||%" <- function(a, b) { if (!is.null(a)) a else b }

geom_flat_violin <- function(mapping = NULL, data = NULL, stat = "ydensity",
                             position = "dodge", trim = TRUE, scale = "area",
                             show.legend = NA, inherit.aes = TRUE, ...) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomFlatViolin,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      trim = trim,
      scale = scale,
      ...
    )
  )
}

GeomFlatViolin <- ggproto("GeomFlatViolin", Geom,
          setup_data = function(data, params) {
            data$width <- data$width %||%
              params$width %||% (resolution(data$x, FALSE) * 0.9)
            
            data %>%
              group_by(group) %>%
              mutate(ymin = min(y),
                     ymax = max(y),
                     xmin = x,
                     xmax = x + width / 2)
          },
          draw_group = function(data, panel_scales, coord) {
            data <- transform(data, xminv = x,
                              xmaxv = x + violinwidth * (xmax - x))
            newdata <- rbind(plyr::arrange(transform(data, x = xminv), y),
                             plyr::arrange(transform(data, x = xmaxv), -y))
            newdata <- rbind(newdata, newdata[1,])
            ggplot2:::ggname("geom_flat_violin", GeomPolygon$draw_panel(newdata, panel_scales, coord))
          },
          draw_key = draw_key_polygon,
          default_aes = aes(weight = 1, colour = "grey20", fill = "white", size = 0.5,
                            alpha = NA, linetype = "solid"),
          required_aes = c("x", "y")
)

raincloud_theme <- theme(
  text = element_text(size = 10),
  axis.title.x = element_text(size = 16),
  axis.title.y = element_text(size = 16),
  axis.text = element_text(size = 14),
  axis.text.x = element_text(angle = 45, vjust = 0.5),
  legend.title = element_text(size = 16),
  legend.text = element_text(size = 16),
  legend.position = "right",
  plot.title = element_text(lineheight = .8, face = "bold", size = 16),
  panel.border = element_blank(),
  panel.grid.minor = element_blank(),
  panel.grid.major = element_blank(),
  axis.line.x = element_line(colour = 'black', size = 0.5, linetype = 'solid'),
  axis.line.y = element_line(colour = 'black', size = 0.5, linetype = 'solid')
)

# ç”»å›¾å‡½æ•°
generate_plot <- function(x_var, y_var, x_label, y_label, title) {
  ggplot(data, aes_string(x = x_var, y = y_var)) +
    geom_point(color = "blue", alpha = 0.6) +
    geom_boxplot(width = 0.2, outlier.shape = NA) +
    geom_flat_violin(aes(fill = ..density..), scale = "width", trim = FALSE, alpha = 0.5) +
    geom_smooth(method = "lm", color = "red", se = TRUE) +
    theme_minimal() +
    raincloud_theme +
    labs(x = x_label, y = y_label, title = title)
}

# ç»˜åˆ¶å››ä¸ªå›¾
p1.1 <- generate_plot("SA_RT", "cohens_d_self_acquaintance", "SA_RT", "Cohen's d (Self - Acquaintance)", "P1.1: RT vs. Cohen's d (Self - Acquaintance)")
p1.2 <- generate_plot("SC_RT", "cohens_d_self_close", "SC_RT", "Cohen's d (Self - Close)", "P1.2: RT vs. Cohen's d (Self - Close)")
p1.3 <- generate_plot("SS_RT", "cohens_d_self_stranger", "SS_RT", "Cohen's d (Self - Stranger)", "P1.3: RT vs. Cohen's d (Self - Stranger)")
p1.4 <- generate_plot("SN_RT", "cohens_d_self_non_person", "SN_RT", "Cohen's d (Self - Non-Person)", "P1.4: RT vs. Cohen's d (Self - Non-Person)")

# æ˜¾ç¤ºæ‰€æœ‰å›¾å½¢
library(gridExtra)
grid.arrange(p1.1, p1.2, p1.3, p1.4, ncol = 2)
```

## Pic1_v2
```{r Package, warning = FALSE,message = FALSE}
# åŠ è½½å¿…è¦çš„åŒ…
library(tidyverse)
library(effsize)      # è®¡ç®— Cohen's d
library(ggridges)     # ç»˜åˆ¶ ridge plot
library(readr)

# è¯»å–æ•°æ®
df <- read_csv("Processed_Data.csv")
```

```{r}
# ç­›é€‰éœ€è¦çš„ Identity æ¡ä»¶
identities <- c("Close", "Stranger", "Celebrity", "Acquaintance", "NonPerson")

# åˆ›å»ºç©ºæ•°æ®æ¡†ä¿å­˜ Cohen's d ç»“æœ
d_results <- data.frame()

# å¾ªç¯æ¯ä¸ª Identity æ¡ä»¶ï¼Œè®¡ç®—å¯¹åº”çš„ Cohen's d ç›¸å¯¹ Self
for (id in identities) {
  df_self <- df %>% filter(Standarlized_Identity == "Self")
  df_other <- df %>% filter(Standarlized_Identity == id)
  
  # inner join by Subject + Matching ä»¥ä¿è¯é…å¯¹
  df_merged <- inner_join(
    df_self, df_other,
    by = c("Subject", "Matching"),
    suffix = c("_Self", "_Other")
  )
  
  # è®¡ç®— Cohen's dï¼ˆé…å¯¹æ ·æœ¬ï¼‰
  d_value <- cohen.d(
    df_merged$RT_ms_Self,
    df_merged$RT_ms_Other,
    paired = TRUE,
    hedges.correction = TRUE
  )$estimate
  
  # ä¿å­˜ç»“æœ
  d_results <- rbind(d_results, data.frame(Identity = id, Cohens_d = d_value))
}
```

```{r}
# è®¡ç®—æ¯ä¸ªè¢«è¯•åœ¨æ¯ä¸ª Identity æ¡ä»¶ä¸‹ä¸ Self çš„ Cohen's dï¼ˆè¿‘ä¼¼æ–¹æ³•ï¼‰
all_d <- df %>%
  filter(Matching == "Matching") %>%
  filter(Standarlized_Identity %in% c("Self", identities)) %>%
  group_by(Subject, Matching, Standarlized_Identity) %>%
  summarise(RT_mean = mean(RT_ms), .groups = "drop") %>%
  pivot_wider(names_from = Standarlized_Identity, values_from = RT_mean) %>%
  rowwise() %>%
  mutate(
    d_Close = (Self - Close) / sd(c(Self, Close)),
    d_Stranger = (Self - Stranger) / sd(c(Self, Stranger)),
    d_Celebrity = (Self - Celebrity) / sd(c(Self, Celebrity)),
    d_Acquaintance = (Self - Acquaintance) / sd(c(Self, Acquaintance)),
    d_NonPerson = (Self - NonPerson) / sd(c(Self, NonPerson))
  ) %>%
  ungroup() %>%
  select(Subject, Matching, starts_with("d_")) %>%
  pivot_longer(
    cols = starts_with("d_"),
    names_to = "Identity",
    values_to = "Cohens_d"
  ) %>%
  mutate(Identity = str_remove(Identity, "d_"))
```

```{r}
ggplot(all_d, aes(x = Cohens_d, y = Identity, fill = Identity)) +
  geom_density_ridges(alpha = 0.7, scale = 1.2) +
  theme_ridges() +
  labs(
    title = "Distribution of Cohen's d (Self vs. Other Identities)",
    x = "Cohen's d (RT: Self - Other)",
    y = "Identity"
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray30") +
  theme(legend.position = "none")

```

```{r}
ggplot(all_d, aes(x = Cohens_d, y = Identity, fill = Identity)) +
  geom_density_ridges(alpha = 0.7, scale = 1.2) +
  facet_wrap(~Matching) +
  theme_ridges() +
  labs(
    title = "Distribution of Cohen's d by Matching Condition",
    x = "Cohen's d (RT: Self - Other)",
    y = "Identity"
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray30") +
  theme(legend.position = "none")
```

## Pic1_v3
```{r}
library(tidyverse)
library(ggridges)
library(effsize)

# åŠ è½½æ•°æ®
df <- read_csv("Processed_Data.csv")

# åªä¿ç•™ Matching æ¡ä»¶
df <- df %>% filter(Matching == "Matching")

# æ¯”è¾ƒç”¨çš„ Identityï¼ˆSelf ä¸ºåŸºå‡†ï¼‰
Identities <- c("Close", "Stranger", "Celebrity", "Acquaintance", "NonPerson")

# è®¡ç®—æ¯ä¸ª Source ä¸‹ Self vs. X çš„ Cohen's d
cohen_d_by_source <- df %>%
  filter(Standarlized_Identity %in% c("Self", Identities)) %>%
  group_by(Source, Standarlized_Identity) %>%
  summarise(RT = list(as.numeric(RT_ms)), .groups = "drop") %>%
  pivot_wider(names_from = Standarlized_Identity, values_from = RT) %>%
  rowwise() %>%
  mutate(
    Cohens_d_Close = if (!is.null(Close) && !is.null(Self)) cohen.d(unlist(Self), unlist(Close), na.rm = TRUE)$estimate else NA,
    Cohens_d_Stranger = if (!is.null(Stranger) && !is.null(Self)) cohen.d(unlist(Self), unlist(Stranger), na.rm = TRUE)$estimate else NA,
    Cohens_d_Celebrity = if (!is.null(Celebrity) && !is.null(Self)) cohen.d(unlist(Self), unlist(Celebrity), na.rm = TRUE)$estimate else NA,
    Cohens_d_Acquaintance = if (!is.null(Acquaintance) && !is.null(Self)) cohen.d(unlist(Self), unlist(Acquaintance), na.rm = TRUE)$estimate else NA,
    Cohens_d_NonPerson = if (!is.null(NonPerson) && !is.null(Self)) cohen.d(unlist(Self), unlist(NonPerson), na.rm = TRUE)$estimate else NA
  ) %>%
  select(Source, starts_with("Cohens_d")) %>%
  pivot_longer(
    cols = starts_with("Cohens_d"),
    names_to = "Identity",
    values_to = "Cohens_d"
  ) %>%
  mutate(Identity = str_replace(Identity, "Cohens_d_", "")) %>%
  drop_na(Cohens_d)

# ç»˜åˆ¶å±±è„Šå›¾
ggplot(cohen_d_by_source, aes(x = Cohens_d, y = Identity, fill = Identity)) +
  geom_density_ridges(alpha = 0.8, scale = 1.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_ridges() +
  labs(
    title = "Distribution of Cohen's d (Self vs. Other) across Articles",
    x = "Cohen's d (RT: Self - Other)",
    y = "Identity"
  ) +
  theme(legend.position = "none")


```

## Pic1_v4








# Copute SDE
## Read csv (åŒºåˆ†å…¬å¼€å’Œæœªå…¬å¼€) [åªåŒ…å«æœ‰Trialè®°å½•çš„]
```{r}
library(dplyr)
library(readr)

## è®¾ç½®æ•°æ®è·¯å¾„
dataPath <- "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = "\\.csv$", full.names = TRUE, recursive = TRUE)

## éœ€è¦æ’é™¤çš„æ–‡ä»¶å¤¹
# exclude_folders <- c("Bukowski_2021_AP", "Golubickis_2021_AP", 
#                      "Hobbs_2023_PM", "Mcivor_2020_EJN", 
#                      "Orellana-Corrales_2021_EP", "Svensson_2021_PR", 
#                      "Wang_2016_EPHPP","Liang_2022_HBM","Hobbs_2021_PM",
#                      "Lee_2023_Cognition","Orellana-Corrales_2021_APP",
#                      "Kirk_2025_BJP","Svensson_2023_QJEP")

## è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
data_files <- data_files[!grepl(paste(exclude_folders, collapse = "|"), data_files)]

## é¢„åˆ†é…å­˜å‚¨å˜é‡ï¼ˆåˆ—è¡¨å­˜å‚¨æ•°æ®ï¼‰
results_list <- list()

## è®¡æ•°å™¨
counter <- 1

## è¯»å– CSV æ–‡ä»¶å¹¶å¤„ç†æ•°æ®
for (i in seq_along(data_files)) {
  file_name <- basename(data_files[i])  # æå–æ–‡ä»¶åï¼ˆå‡è®¾æ–‡ä»¶åä»£è¡¨æ–‡ç« åç§°ï¼‰
  
  Data <- read_csv(data_files[i], show_col_types = FALSE) %>%
    mutate(across(where(is.character), as.character))  # ç¡®ä¿å­—ç¬¦å˜é‡ç±»å‹ä¸€è‡´
  
  # ç¡®ä¿æ•°æ®åŒ…å«æ‰€éœ€å˜é‡
  if (all(c("RT_ms", "ACC", "Standarlized_Identity", "Subject", "Matching", "Trial") %in% names(Data))) {
    
    # ç”Ÿæˆå”¯ä¸€æ ‡è¯†æ¯ç¯‡æ–‡ç« çš„ Subject IDï¼Œå¹¶æ·»åŠ  Source å˜é‡
    Data <- Data %>%
      mutate(
        Subject = paste0(file_name, "_", Subject),
        Source = file_name  # **æ–°å¢å˜é‡ï¼Œæ ‡è®°æ¥æºæ–‡ç« **
      )
    
    # è¿‡æ»¤ RT åœ¨åˆç†èŒƒå›´å†…çš„è¡Œ
    # Data <- Data %>%
    #   filter(RT_ms > 10 & RT_ms < 5000, ACC %in% c(0, 1))  # è¿‡æ»¤å¼‚å¸¸å€¼

    # **å­˜å…¥åˆ—è¡¨**
    results_list[[counter]] <- Data %>%
      select(Source, Subject, Trial, Block, Matching, Standarlized_Identity, RT_ms, ACC)  # **ä¿ç•™ Source å˜é‡**
    
    counter <- counter + 1
  }
  print(paste('å®Œæˆæ•°æ®é›†', i, 'å¤„ç†'))
}

# **åˆå¹¶æ‰€æœ‰æ•°æ®**
results <- bind_rows(results_list)

# **æ£€æŸ¥åˆå¹¶åçš„æ•°æ®**
print("æ•°æ®å¤„ç†å®Œæˆï¼Œå·²å­˜å…¥ `results` å˜é‡")

# **è¾“å‡ºæ•°æ®åˆ° CSV**
write.csv(results, "Processed_Data_for_SDE.csv", row.names = FALSE)
```

## [åŒ…å«Block]
```{r}
library(dplyr)
library(readr)

## è®¾ç½®æ•°æ®è·¯å¾„
dataPath <- "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = "\\.csv$", full.names = TRUE, recursive = TRUE)

## éœ€è¦æ’é™¤çš„æ–‡ä»¶å¤¹
# exclude_folders <- c("Bukowski_2021_AP", "Golubickis_2021_AP", 
#                      "Hobbs_2023_PM", "Mcivor_2020_EJN", 
#                      "Orellana-Corrales_2021_EP", "Svensson_2021_PR", 
#                      "Wang_2016_EPHPP")

## è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
data_files <- data_files[!grepl(paste(exclude_folders, collapse = "|"), data_files)]

## é¢„åˆ†é…å­˜å‚¨å˜é‡ï¼ˆåˆ—è¡¨å­˜å‚¨æ•°æ®ï¼‰
results_list <- list()

## è®¡æ•°å™¨
counter <- 1

## è¯»å– CSV æ–‡ä»¶å¹¶å¤„ç†æ•°æ®
for (i in seq_along(data_files)) {
  file_name <- basename(data_files[i])  # æå–æ–‡ä»¶åï¼ˆå‡è®¾æ–‡ä»¶åä»£è¡¨æ–‡ç« åç§°ï¼‰
  
  Data <- read_csv(data_files[i], show_col_types = FALSE) %>%
    mutate(across(where(is.character), as.character))  # ç¡®ä¿å­—ç¬¦å˜é‡ç±»å‹ä¸€è‡´
  
  # ç¡®ä¿æ•°æ®åŒ…å«æ‰€éœ€å˜é‡
  if (all(c("RT_ms", "ACC", "Standarlized_Identity", "Subject", "Matching", "Block", "Trial","Gender") %in% names(Data))) {
    
    # ç”Ÿæˆå”¯ä¸€æ ‡è¯†æ¯ç¯‡æ–‡ç« çš„ Subject IDï¼Œå¹¶æ·»åŠ  Source å˜é‡
    Data <- Data %>%
      mutate(
        Subject = paste0(file_name, "_", Subject),
        Source = file_name  # **æ–°å¢å˜é‡ï¼Œæ ‡è®°æ¥æºæ–‡ç« **
      )
    
    # è¿‡æ»¤ RT åœ¨åˆç†èŒƒå›´å†…çš„è¡Œ
    # Data <- Data %>%
    #   filter(RT_ms > 10 & RT_ms < 5000, ACC %in% c(0, 1))  # è¿‡æ»¤å¼‚å¸¸å€¼

    # **å­˜å…¥åˆ—è¡¨**
    results_list[[counter]] <- Data %>%
      select(Source, Subject, Block, Trial, Matching, Standarlized_Identity, RT_ms, ACC)  # **ä¿ç•™ Source å˜é‡**
    
    counter <- counter + 1
  }
  print(paste('å®Œæˆæ•°æ®é›†', i, 'å¤„ç†'))
}

# **åˆå¹¶æ‰€æœ‰æ•°æ®**
results <- bind_rows(results_list)

# **æ£€æŸ¥åˆå¹¶åçš„æ•°æ®**
print("æ•°æ®å¤„ç†å®Œæˆï¼Œå·²å­˜å…¥ `results` å˜é‡")

# **è¾“å‡ºæ•°æ®åˆ° CSV**
write.csv(results, "Processed_Data_for_SDE.csv", row.names = FALSE)
```


## Test01
```{r}
library(dplyr)
library(lme4)  # ç”¨äºLMM
library(lmerTest)  # æä¾›på€¼ï¼ˆå¯é€‰ï¼‰

# å‡è®¾ä½ çš„æ•°æ®å·²åŠ è½½åˆ° `results` ä¸­
# å¦‚æœæ²¡æœ‰ï¼Œå…ˆè¿è¡Œä½ çš„åŸå§‹ä»£ç ç”Ÿæˆ `results`

# 1. æŒ‰Subjectå’ŒBlockæ’åºï¼Œå¹¶ç”Ÿæˆlagå˜é‡
data_seq <- results %>%
  arrange(Subject, Block, Trial) %>%
  group_by(Subject, Block) %>%  # åœ¨æ¯ä¸ªSubjectå’ŒBlockå†…æ“ä½œ
  mutate(
    Lag1_Identity = lag(Standarlized_Identity, 1),  # å‰1æ¬¡
    Lag2_Identity = lag(Standarlized_Identity, 2),  # å‰2æ¬¡
    Lag3_Identity = lag(Standarlized_Identity, 3),  # å‰3æ¬¡
    Lag4_Identity = lag(Standarlized_Identity, 4),  # å‰4æ¬¡
    Lag5_Identity = lag(Standarlized_Identity, 5),  # å‰5æ¬¡
    Lag6_Identity = lag(Standarlized_Identity, 6),  # å‰6æ¬¡
    Lag7_Identity = lag(Standarlized_Identity, 7)   # å‰7æ¬¡
  ) %>%
  ungroup()

# 2. ç§»é™¤å¼€å¤´æ²¡æœ‰å®Œæ•´lagæ•°æ®çš„è¡Œ
data_seq_clean <- data_seq %>%
  filter(!is.na(Lag7_Identity))  # ç¡®ä¿æ‰€æœ‰lagå˜é‡éƒ½éNA

# 3. æ£€æŸ¥æ•°æ®
print("åºåˆ—ä½ç½®æ•ˆåº”æ•°æ®å·²ç”Ÿæˆï¼Œä»¥ä¸‹æ˜¯å‰å‡ è¡Œï¼š")
print(head(data_seq_clean))

# 4. å»ºç«‹LMMæ¨¡å‹åˆ†æRT
# å›ºå®šæ•ˆåº”ï¼šå½“å‰Identity + å‰7æ¬¡Identity
# éšæœºæ•ˆåº”ï¼šSubject
rt_lmm <- lmer(RT_ms ~ Standarlized_Identity + Lag1_Identity + Lag2_Identity + 
               Lag3_Identity + Lag4_Identity + Lag5_Identity + Lag6_Identity + 
               Lag7_Identity + (1 | Subject), 
               data = data_seq_clean)

# 5. æŸ¥çœ‹æ¨¡å‹ç»“æœ
summary(rt_lmm)

# 6. ï¼ˆå¯é€‰ï¼‰ä¿å­˜æ¨¡å‹ç»“æœåˆ°æ–‡ä»¶
sink("RT_LMM_Summary.txt")
print(summary(rt_lmm))
sink()

# 7. ä¿å­˜å¤„ç†åçš„æ•°æ®
write.csv(data_seq_clean, "Sequence_Effect_Data.csv", row.names = FALSE)
```


## Test02
```{r}
# åŠ è½½å¿…è¦çš„åº“
library(dplyr)
library(ggplot2)
library(readr)

# è¯»å–æ•°æ®
data <- read_csv("Processed_Data_for_SDE.csv")

# æŒ‰ Sourceã€Subject å’Œ Trial æ’åº
data <- data %>%
  arrange(Source, Subject, Trial) %>%
  group_by(Source, Subject) %>%
  mutate(
    Prev_Matching = lag(Matching),  # è®¡ç®—ä¸Šä¸€è¯•æ¬¡çš„Matching
    Prev_ACC = lag(ACC),            # è®¡ç®—ä¸Šä¸€è¯•æ¬¡çš„æ­£ç¡®ç‡
    Prev_RT_ms = lag(RT_ms)         # è®¡ç®—ä¸Šä¸€è¯•æ¬¡çš„ååº”æ—¶
  ) %>%
  ungroup()

# è®¡ç®—ä¸Šä¸€è¯•æ¬¡çš„Matchingå¯¹å½“å‰è¯•æ¬¡ACCçš„å½±å“
acc_model <- glm(ACC ~ Prev_Matching, data = data, family = binomial)
summary(acc_model)

# è®¡ç®—ä¸Šä¸€è¯•æ¬¡çš„Matchingå¯¹å½“å‰è¯•æ¬¡RT_msçš„å½±å“
rt_model <- lm(RT_ms ~ Prev_Matching, data = data)
summary(rt_model)

# å¯è§†åŒ–ä¸Šä¸€è¯•æ¬¡Matchingå¯¹å½“å‰è¯•æ¬¡RT_msçš„å½±å“
ggplot(data, aes(x = Prev_Matching, y = RT_ms)) +
  geom_boxplot() +
  labs(title = "Previous Matching Condition and Current RT_ms",
       x = "Previous Matching Condition",
       y = "Reaction Time (ms)") +
  theme_minimal()

```


## Test03ï¼ˆResultï¼‰
```{r}
# åŠ è½½å¿…è¦çš„åŒ…
library(tidyverse)
library(lme4)
library(lmerTest)
library(ggplot2)

# è¯»å–æ•°æ®
data <- read_csv("Processed_Data_for_SDE.csv")

# æŒ‰ Sourceï¼ˆå®éªŒæ¥æºï¼‰ã€Subjectï¼ˆè¢«è¯•ï¼‰ã€Trialï¼ˆè¯•æ¬¡ï¼‰æ’åºï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
data <- data %>% arrange(Source, Subject, Trial)

# è®¡ç®— Lag-1 å˜é‡ï¼ˆä¸Šä¸€è¯•æ¬¡çš„ Matching æ¡ä»¶ï¼‰
data <- data %>%
  group_by(Source, Subject) %>%
  mutate(Prev_Matching = lag(Matching)) %>%
  ungroup()

# ç§»é™¤é¦–ä¸ªè¯•æ¬¡ï¼ˆå› ä¸ºæ²¡æœ‰ä¸Šä¸€è¯•æ¬¡ï¼‰
data <- na.omit(data)

# æ¸…ç† ACCï¼šå°† 1 ä»¥å¤–çš„æ‰€æœ‰å€¼ï¼ˆåŒ…æ‹¬ NAï¼‰ç»Ÿä¸€å¤„ç†ä¸º 0
data <- data %>%
  mutate(ACC = ifelse(ACC == 1, 1, 0))

# ç¡®ä¿ Matching å’Œ Prev_Matching æ˜¯å› å­å˜é‡
data$Matching <- as.factor(data$Matching)
data$Prev_Matching <- as.factor(data$Prev_Matching)

# æ„å»ºé€»è¾‘å›å½’æ¨¡å‹ï¼ˆå› å˜é‡ï¼šACCï¼Œé¢„æµ‹å˜é‡ï¼šPrev_Matchingï¼‰
acc_model <- glmer(ACC ~ Prev_Matching + (1 | Subject) + (1 | Source) + (1 | Block),
                   family = binomial, data = data)

# è¾“å‡ºæ¨¡å‹æ‘˜è¦
summary(acc_model)

```

```{r}
# é€»è¾‘å›å½’æ¨¡å‹ï¼ˆå› å˜é‡ï¼šACCï¼Œé¢„æµ‹å˜é‡ï¼šPrev_Matchingï¼‰
acc_model <- glmer(ACC ~ Prev_Matching + (1 | Subject) + (1 | Source) + (1 | Block),
                   family = binomial, data = data)

# è¾“å‡ºç»“æœ
summary(acc_model)
```

```{r}
# è®¡ç®—ä¸åŒ Lagï¼ˆ1~7ï¼‰ æ¡ä»¶ä¸‹çš„ç›¸å…³ç³»æ•°
compute_autocorr <- function(data, max_lag = 7) {
  autocorr_results <- data.frame(Lag = integer(), Beta = numeric(), SE = numeric(), P_Value = numeric())
  
  for (lag in 1:max_lag) {
    data <- data %>%
      group_by(Source, Subject) %>%
      mutate(Prev_Matching = lag(Matching, lag)) %>%
      ungroup() %>%
      na.omit()
    
    # è®¡ç®—æ··åˆæ¨¡å‹
    model <- glmer(ACC ~ Prev_Matching + (1 | Subject) + (1 | Source) + (1 | Block), family = binomial, data = data)
    
    # æå– Î² ç³»æ•°ã€æ ‡å‡†è¯¯å’Œ p å€¼
    beta <- summary(model)$coefficients["Prev_MatchingNonmatching", "Estimate"]
    se <- summary(model)$coefficients["Prev_MatchingNonmatching", "Std. Error"]
    p_value <- summary(model)$coefficients["Prev_MatchingNonmatching", "Pr(>|z|)"]
    
    # å­˜å‚¨ç»“æœ
    autocorr_results <- rbind(autocorr_results, data.frame(Lag = lag, Beta = beta, SE = se, P_Value = p_value))
  }
  
  return(autocorr_results)
}

# è®¡ç®— Lag-1 ~ Lag-7 çš„è‡ªç›¸å…³
autocorr_results <- compute_autocorr(data, max_lag = 7)

# æŸ¥çœ‹ç»“æœ
print(autocorr_results)
```

```{r}
# ç”»å›¾ï¼ˆä»¿ç…§ Rahnev çš„ NHB å›¾ï¼‰
ggplot(autocorr_results, aes(x = Lag, y = Beta)) +
  geom_point(size = 4, color = "blue") +                        # ç”»ç‚¹
  geom_errorbar(aes(ymin = Beta - SE, ymax = Beta + SE),        # è¯¯å·®æ¡
                width = 0.2, color = "blue") +
  geom_line(size = 1, color = "blue") +                         # è¿æ¥çº¿
  theme_minimal(base_size = 16) +
  labs(title = "Serial Dependence in Accuracy (Lag-1 to Lag-7)",
       x = "Lag (Previous Trial)",
       y = "Autocorrelation (Beta Â± SEM)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```

```{r}
# åŠ è½½å¿…è¦çš„åŒ…
library(tidyverse)
library(lme4)
library(lmerTest)
library(ggplot2)

# è¯»å–æ•°æ®
data <- read_csv("Processed_Data_for_SDE.csv")

# æ’åºï¼Œç¡®ä¿æ—¶é—´é¡ºåºæ­£ç¡®
data <- data %>% arrange(Source, Subject, Trial)

# å°† RT_ms è½¬æ¢ä¸ºæ•°å€¼ï¼ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
data$RT_ms <- as.numeric(data$RT_ms)

# ç§»é™¤ RT ä¸ºç©º æˆ– å°äº 200ms / å¤§äº 3000ms çš„å¼‚å¸¸å€¼ï¼ˆå¯é€‰ï¼‰
data <- data %>% filter(RT_ms >= 200 & RT_ms <= 3000)

# ç¡®ä¿ Matching æ˜¯å› å­å˜é‡
data$Matching <- as.factor(data$Matching)

# ====== è‡ªå®šä¹‰å‡½æ•°ï¼šè®¡ç®— RT çš„åºåˆ—ä½ç½®æ•ˆåº” ======
compute_rt_autocorr <- function(data, max_lag = 7) {
  autocorr_results <- data.frame(Lag = integer(), Beta = numeric(), SE = numeric(), P_Value = numeric())
  
  for (lag in 1:max_lag) {
    data_lag <- data %>%
      group_by(Source, Subject) %>%
      mutate(Prev_Matching = lag(Matching, lag)) %>%
      ungroup() %>%
      drop_na(Prev_Matching, RT_ms)
    
    # å»ºç«‹çº¿æ€§æ··åˆæ¨¡å‹ï¼ˆLMMï¼‰
    model <- lmer(RT_ms ~ Prev_Matching + (1 | Subject) + (1 | Source) + (1 | Block), data = data_lag)
    
    # æå– Î² ç³»æ•°ã€æ ‡å‡†è¯¯å’Œ p å€¼ï¼ˆä»¥ Prev_MatchingNonmatching ä¸ºå‚è€ƒï¼‰
    beta <- summary(model)$coefficients["Prev_MatchingNonmatching", "Estimate"]
    se <- summary(model)$coefficients["Prev_MatchingNonmatching", "Std. Error"]
    p_value <- summary(model)$coefficients["Prev_MatchingNonmatching", "Pr(>|t|)"]
    
    # å­˜å‚¨ç»“æœ
    autocorr_results <- rbind(autocorr_results,
                              data.frame(Lag = lag, Beta = beta, SE = se, P_Value = p_value))
  }
  
  return(autocorr_results)
}

# è¿è¡Œå‡½æ•°ï¼Œè®¡ç®— RT çš„ Lag-1 ~ Lag-7 åºåˆ—æ•ˆåº”
rt_autocorr_results <- compute_rt_autocorr(data, max_lag = 7)

# æŸ¥çœ‹ç»“æœ
print(rt_autocorr_results)

# ====== å¯è§†åŒ– Lag çš„ RT åºåˆ—æ•ˆåº” ======
ggplot(rt_autocorr_results, aes(x = Lag, y = Beta)) +
  geom_point(size = 4, color = "darkred") +
  geom_errorbar(aes(ymin = Beta - SE, ymax = Beta + SE), width = 0.2, color = "darkred") +
  geom_line(size = 1, color = "darkred") +
  theme_minimal(base_size = 16) +
  labs(title = "Serial Dependence in RT (Lag-1 to Lag-7)",
       x = "Lag (Previous Trial)",
       y = "Effect of Prev_Matching on RT (Beta Â± SEM)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```


## Test04
```{r}
# åŠ è½½å¿…è¦çš„åŒ…
library(tidyverse)
library(lme4)
library(lmerTest)
library(broom.mixed)

# è¯»å–æ•°æ®
data <- read_csv("Processed_Data_for_SDE.csv")

# é¢„å¤„ç†ï¼šç”Ÿæˆlagå˜é‡
data_preprocessed <- data %>%
  arrange(Source, Subject, Trial) %>%
  group_by(Subject) %>%
  mutate(
    Lag1_Matching = lag(Matching),
    Lag2_Matching = lag(Matching, 2),
    Lag3_Matching = lag(Matching, 3),
    Lag4_Matching = lag(Matching, 4),
    Lag5_Matching = lag(Matching, 5),
    Lag6_Matching = lag(Matching, 6),
    Lag7_Matching = lag(Matching, 7)
  ) %>%
  ungroup()

# åˆå§‹åŒ–ç»“æœå­˜å‚¨
results <- tibble()

# åˆ†æä¸åŒlagçš„æ•ˆåº”
for (lag_num in 1:7) {
  # é€‰æ‹©å¯¹åº”çš„lagå˜é‡
  lag_var <- paste0("Lag", lag_num, "_Matching")
  
  # è¿‡æ»¤æœ‰æ•ˆæ•°æ®
  temp_data <- data_preprocessed %>%
    filter(!is.na(!!sym(lag_var))) %>%
    rename(Current_Matching = Matching)
  
  # è¿è¡Œæ··åˆæ•ˆåº”æ¨¡å‹ï¼ˆä»¥ååº”æ—¶ä¸ºä¾‹ï¼‰
  model <- lmer(
    RT_ms ~ !!sym(lag_var) + (1 | Subject) + (1 | Source),
    data = temp_data
  )
  
  # æå–ç»“æœ
  summ <- summary(model)
  coeffs <- summ$coefficients
  
  # å­˜å‚¨ç»“æœ
  results <- results %>% bind_rows(
    tibble(
      Lag = lag_num,
      Beta = coeffs[2, "Estimate"],
      SE = coeffs[2, "Std. Error"],
      t = coeffs[2, "t value"],
      p = coeffs[2, "Pr(>|t|)"]
    )
  )
}

# å¯è§†åŒ–
ggplot(results, aes(x = Lag, y = Beta)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray60") +
  geom_line(color = "steelblue") +
  geom_point(size = 3, color = "steelblue") +
  geom_errorbar(aes(ymin = Beta - SE, ymax = Beta + SE), 
                width = 0.2, color = "steelblue") +
  geom_text(aes(label = ifelse(p < 0.001, "***", 
                             ifelse(p < 0.01, "**",
                                    ifelse(p < 0.05, "*", "")))),
            vjust = -0.5, size = 5) +
  scale_x_continuous(breaks = 1:7) +
  labs(x = "Lag", 
       y = "Î² Coefficient",
       title = "Serial Dependence in Reaction Time",
       subtitle = "Effect of Previous Trial's Matching Condition on Current Trial RT") +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
```


## Test05
```{r}
library(tidyverse)
library(lme4)
library(data.table)
library(lmerTest) 

# è¯»å–æ•°æ®
df <- read.csv("Processed_Data_for_SDE.csv")

# è½¬æ¢å˜é‡ç±»å‹
df <- df %>%
  mutate(
    Subject = as.factor(Subject),
    Source = as.factor(Source),
    Matching = as.factor(Matching),
    Standarlized_Identity = as.factor(Standarlized_Identity)
  ) %>%
  arrange(Subject, Trial)  # æŒ‰ç…§è¢«è¯• & è¯•æ¬¡é¡ºåºæ’åº

```

```{r}
# ä½¿ç”¨ data.table åŠ é€Ÿæ»åå˜é‡ç”Ÿæˆ
df_dt <- as.data.table(df)

# å¯¹æ¯ä¸ªè¢«è¯•åˆ†åˆ«ç”Ÿæˆæ»å RT_ms å˜é‡
for (i in 1:7) {
  df_dt[, paste0("RT_ms_n", i) := shift(RT_ms, n = i, type = "lag"), by = Subject]
}

```

```{r}
#åˆ é™¤å‰7è¡Œç¼ºå¤±ï¼ˆç”±äºæ»åå˜é‡å¯¼è‡´ï¼‰
df_clean <- df_dt %>% drop_na(RT_ms_n1, RT_ms_n2, RT_ms_n3, RT_ms_n4, RT_ms_n5, RT_ms_n6, RT_ms_n7)
```

```{r}
# æ„å»ºæ··åˆæ•ˆåº”æ¨¡å‹ï¼šå½“å‰RTå—å‰1~7ä¸ªRTå½±å“
fit <- lmer(RT_ms ~ RT_ms_n1 + RT_ms_n2 + RT_ms_n3 + RT_ms_n4 + RT_ms_n5 + RT_ms_n6 + RT_ms_n7 + (1 | Subject) + (1 | Source) + (1 | Block), 
            data = df_clean)


coef_summary <- as.data.frame(coef(summary(fit)))
coef_summary$p_value <- 2 * (1 - pnorm(abs(coef_summary$"t value")))
print(coef_summary)
summary(fit)
```

```{r}
# æå–å›ºå®šæ•ˆåº”å¹¶ç”»å›¾
tmp <- as.data.frame(confint(fit))
tmp <- tmp[grep("RT_ms_n", rownames(tmp)), ]
tmp$Estimate <- fixef(fit)[grep("RT_ms_n", names(fixef(fit)))]
tmp$lwr <- tmp$`2.5 %`
tmp$upr <- tmp$`97.5 %`
tmp$History <- paste0("RT n-", 1:7)

# å¯è§†åŒ–
ggplot(tmp, aes(x = History, y = Estimate, ymin = lwr, ymax = upr)) +
  geom_point(size = 3) +
  geom_errorbar(width = 0.2) +
  theme_minimal() +
  labs(title = "Serial Dependence of RT (n-1 to n-7)",
       x = "Lagged RT",
       y = "Effect on Current RT")

```

## Test06ï¼ˆGood Fit)
### RT
```{r}
library(tidyverse)
library(lme4)
library(data.table)

# è¯»å–æ•°æ®
df <- read_csv("Processed_Data_for_SDE.csv")
# è½¬æ¢å˜é‡ç±»å‹
df <- df %>%
  mutate(
    Subject = as.factor(Subject),
    Block = as.factor(Block),
    Trial = as.factor(Trial),
    Source = as.factor(Source),
    Matching = as.factor(Matching),
    Standarlized_Identity = as.factor(Standarlized_Identity)
    
  ) %>%
  arrange(Subject, Block, Trial)  # æŒ‰ç…§è¢«è¯• & è¯•æ¬¡é¡ºåºæ’åº

```

### log7
```{r}
# ä½¿ç”¨ data.table åŠ é€Ÿæ»åå˜é‡ç”Ÿæˆ
df_dt <- as.data.table(df)

# å¯¹æ¯ä¸ªè¢«è¯•åˆ†åˆ«ç”Ÿæˆæ»å RT_ms å˜é‡
for (i in 1:7) {
  df_dt[, paste0("RT_ms_n", i) := shift(RT_ms, n = i, type = "lag"), by = Subject]
}

```

```{r}
#åˆ é™¤å‰7è¡Œç¼ºå¤±ï¼ˆç”±äºæ»åå˜é‡å¯¼è‡´ï¼‰
df_clean <- df_dt %>% drop_na(RT_ms_n1, RT_ms_n2, RT_ms_n3, RT_ms_n4, RT_ms_n5, RT_ms_n6, RT_ms_n7)
```

```{r}
# æ„å»ºæ··åˆæ•ˆåº”æ¨¡å‹ï¼šå½“å‰RTå—å‰1~7ä¸ªRTå½±å“
fit <- lmer(RT_ms ~ RT_ms_n1 + RT_ms_n2 + RT_ms_n3 + RT_ms_n4 + RT_ms_n5 + RT_ms_n6 + RT_ms_n7 + (1 | Source)+ (1 | Subject) + (1 | Block), 
            data = df_clean)

coef_summary <- as.data.frame(coef(summary(fit)))
coef_summary$p_value <- 2 * (1 - pnorm(abs(coef_summary$"t value")))
print(coef_summary)
summary(fit)
```

```{r}
# æå–å›ºå®šæ•ˆåº”å¹¶ç”»å›¾
tmp <- as.data.frame(confint(fit))
tmp <- tmp[grep("RT_ms_n", rownames(tmp)), ]
tmp$Estimate <- fixef(fit)[grep("RT_ms_n", names(fixef(fit)))]
tmp$lwr <- tmp$`2.5 %`
tmp$upr <- tmp$`97.5 %`
tmp$History <- paste0("RT n-", 1:7)

# å¯è§†åŒ–
ggplot(tmp, aes(x = History, y = Estimate, ymin = lwr, ymax = upr)) +
  geom_point(size = 3) +
  geom_errorbar(width = 0.2) +
  theme_minimal() +
  labs(title = "Serial Dependence of RT (n-1 to n-7)",
       x = "Lagged RT",
       y = "Effect on Current RT")

```



## Test_Age log?
```{r}
# åŠ è½½å¿…è¦çš„åŒ…
library(tidyverse)
library(e1071)      # ç”¨äº skewness
library(ggplot2)    # å¯è§†åŒ–
library(ggpubr)     # QQå›¾
library(readr)      # è¯»å–CSV

# è¯»å–æ•°æ®
data_v1 <- read_csv("../3_Code/Processed_Data_by_age&gender.csv")

  # æŸ¥çœ‹å‰å‡ è¡Œ
head(data_v1)

# ç»˜åˆ¶ç›´æ–¹å›¾
ggplot(data_v1, aes(x = RT_ms)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "black") +
  theme_minimal() +
  labs(title = "Histogram of RT_ms")

# å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å€¼ï¼ˆéæ•°å€¼å°†å˜æˆ NAï¼‰
data_v1$RT_ms <- as.numeric(data_v1$RT_ms)

# ååº¦
skew_val <- skewness(data$RT_ms, na.rm = TRUE)
cat("Skewness of RT_ms:", skew_val, "\n")


```

```{r}
# æ·»åŠ  log å˜é‡
data_v1$log_RT_ms <- log(data_v1$RT_ms)

# æ£€æŸ¥åˆ†å¸ƒ
ggplot(data_v1, aes(x = log_RT_ms)) +
  geom_histogram(bins = 50, fill = "darkgreen", color = "black") +
  theme_minimal() +
  labs(title = "Histogram of log(RT_ms)")

# è®¡ç®— log åååº¦
library(e1071)
skewness(data_v1$log_RT_ms, na.rm = TRUE)

```

```{r}
# åŠ è½½å¿…è¦çš„åŒ…
library(tidyverse)
library(e1071)      # ç”¨äº skewness
library(ggplot2)    # å¯è§†åŒ–
library(ggpubr)     # QQå›¾
library(readr)      # è¯»å–CSV

# è¯»å–æ•°æ®
data_v1 <- read_csv("../3_Code/Processed_Data_by_age&gender.csv")

  # æŸ¥çœ‹å‰å‡ è¡Œ
head(data_v1)

# ç»˜åˆ¶ç›´æ–¹å›¾
ggplot(data_v1, aes(x = Age)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "black") +
  theme_minimal() +
  labs(title = "Histogram of Age")

# å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å€¼ï¼ˆéæ•°å€¼å°†å˜æˆ NAï¼‰
data_v1$RT_ms <- as.numeric(data_v1$RT_ms)

# ååº¦
skew_val <- skewness(data$Age, na.rm = TRUE)
cat("Skewness of RT_ms:", skew_val, "\n")


```


```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–å¹¶ç­›é€‰ Nonmatching æ¡ä»¶
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Nonmatching", Standarlized_Identity %in% c("Self", "Stranger"))

# è·å–å”¯ä¸€è¢«è¯•å¹¶æ‰“ä¹±é¡ºåº
set.seed(42)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

# è®¾å®šæ¯æ­¥çš„æ ·æœ¬é‡
sample_sizes <- seq(60, length(shuffled_subjects), by = 40)

# åˆå§‹åŒ–ç»“æœå­˜å‚¨
result_df <- data.frame(SampleSize = integer(), Cohens_d = numeric())

# å¾ªç¯é€æ­¥å¢åŠ æ ·æœ¬é‡è®¡ç®—æ•ˆåº”é‡
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects)

  summary_data <- sample_data %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT)

  if (all(c("Self", "Stranger") %in% colnames(summary_data))) {
    temp <- summary_data %>% filter(!is.na(Self) & !is.na(Stranger))
    if (nrow(temp) >= 2) {
      d <- cohen.d(temp$Self, temp$Stranger, paired = TRUE)$estimate
      result_df <- rbind(result_df, data.frame(SampleSize = n, Cohens_d = d))
    }
  }
}


# ç»˜åˆ¶æ ·æœ¬é‡ vs Cohen's d çš„æŠ˜çº¿å›¾
ggplot(result_df, aes(x = SampleSize, y = Cohens_d)) +
  geom_line(color = "steelblue", size = 1) +
  geom_point(color = "darkred", size = 2) +
  theme_minimal() +
  labs(title = "SPEæ•ˆåº”é‡éšæ ·æœ¬é‡å˜åŒ–ï¼ˆCohen's d, Nonmatchingï¼‰",
       x = "æ ·æœ¬é‡ï¼ˆè¢«è¯•æ•°ï¼‰", y = "æ•ˆåº”é‡ Cohen's d")
```


```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–å¹¶ç­›é€‰ Nonmatching æ¡ä»¶
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Nonmatching", Standarlized_Identity %in% c("Self", "Close"))

# è·å–å”¯ä¸€è¢«è¯•å¹¶æ‰“ä¹±é¡ºåº
set.seed(42)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

# è®¾å®šæ¯æ­¥çš„æ ·æœ¬é‡
sample_sizes <- seq(60, length(shuffled_subjects), by = 10)

# åˆå§‹åŒ–ç»“æœå­˜å‚¨
result_df <- data.frame(SampleSize = integer(), Cohens_d = numeric())

# å¾ªç¯é€æ­¥å¢åŠ æ ·æœ¬é‡è®¡ç®—æ•ˆåº”é‡
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects)

  summary_data <- sample_data %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT)

  if (all(c("Self", "Close") %in% colnames(summary_data))) {
    temp <- summary_data %>% filter(!is.na(Self) & !is.na(Close))
    if (nrow(temp) >= 2) {
      d <- cohen.d(temp$Self, temp$Close, paired = TRUE)$estimate
      result_df <- rbind(result_df, data.frame(SampleSize = n, Cohens_d = d))
    }
  }
}


# ç»˜åˆ¶æ ·æœ¬é‡ vs Cohen's d çš„æŠ˜çº¿å›¾
ggplot(result_df, aes(x = SampleSize, y = Cohens_d)) +
  geom_line(color = "steelblue", size = 1) +
  geom_point(color = "darkred", size = 2) +
  theme_minimal() +
  labs(title = "SPEæ•ˆåº”é‡éšæ ·æœ¬é‡å˜åŒ–ï¼ˆCohen's d, Nonmatchingï¼‰",
       x = "æ ·æœ¬é‡ï¼ˆè¢«è¯•æ•°ï¼‰", y = "æ•ˆåº”é‡ Cohen's d")
```

```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–å¹¶ç­›é€‰ Matching æ¡ä»¶
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Matching", Standarlized_Identity %in% c("Self", "Stranger"))

# # è®¡ç®—æ¯ä¸ªè¢«è¯•çš„å¹³å‡ RTï¼ˆSelf vs. Strangerï¼‰
# per_subject_diff <- data_filtered %>%
#   group_by(Subject, Standarlized_Identity) %>%
#   summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
#   pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT) %>%
#   filter(!is.na(Self) & !is.na(Stranger)) %>%
#   mutate(Diff_SelfMinusStranger = Self - Stranger)
# 
# # ä¿å­˜ä¸º CSV
# write_csv(per_subject_diff, "Per_Subject_SPE_Diff.csv")

# è·å–å”¯ä¸€è¢«è¯•å¹¶æ‰“ä¹±é¡ºåº
set.seed(42)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

# è®¾å®šæ¯æ­¥çš„æ ·æœ¬é‡
sample_sizes <- seq(60, length(shuffled_subjects), by = 40)

# åˆå§‹åŒ–ç»“æœå­˜å‚¨
result_df <- data.frame(SampleSize = integer(), Cohens_d = numeric())

# å¾ªç¯é€æ­¥å¢åŠ æ ·æœ¬é‡è®¡ç®—æ•ˆåº”é‡
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects)

  summary_data <- sample_data %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT)

  if (all(c("Self", "Stranger") %in% colnames(summary_data))) {
    temp <- summary_data %>% filter(!is.na(Self) & !is.na(Stranger))
    if (nrow(temp) >= 2) {
      d <- cohen.d(temp$Self, temp$Stranger, paired = TRUE)$estimate
      result_df <- rbind(result_df, data.frame(SampleSize = n, Cohens_d = d))
    }
  }
}

# APA é£æ ¼å›¾å½¢è®¾ç½®
ggplot(result_df, aes(x = SampleSize, y = Cohens_d)) +
  geom_line(color = "black", size = 1.2) +
  geom_point(color = "black", size = 2.5) +
  theme_classic(base_size = 14, base_family = "serif") +
  labs(
    title = "Effect Size (Cohen's d) by Sample Size (Matching Condition)",
    x = "Sample Size (Number of Participants)",
    y = "Cohen's d (Self vs. Stranger)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank()
  )

ggsave("SPE_CohensD_by_SampleSize_APA.tiff", dpi = 300, width = 6, height = 4, units = "in")

```

```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–å¹¶ç­›é€‰ Nonmatching æ¡ä»¶
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Nonmatching", Standarlized_Identity %in% c("Self", "Stranger"))

# # è®¡ç®—æ¯ä¸ªè¢«è¯•çš„å¹³å‡ RTï¼ˆSelf vs. Strangerï¼‰
# per_subject_diff <- data_filtered %>%
#   group_by(Subject, Standarlized_Identity) %>%
#   summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
#   pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT) %>%
#   filter(!is.na(Self) & !is.na(Stranger)) %>%
#   mutate(Diff_SelfMinusStranger = Self - Stranger)
# 
# # ä¿å­˜ä¸º CSV
# write_csv(per_subject_diff, "Per_Subject_SPE_Diff.csv")

# è·å–å”¯ä¸€è¢«è¯•å¹¶æ‰“ä¹±é¡ºåº
set.seed(42)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

# è®¾å®šæ¯æ­¥çš„æ ·æœ¬é‡
sample_sizes <- seq(60, length(shuffled_subjects), by = 40)

# åˆå§‹åŒ–ç»“æœå­˜å‚¨
result_df <- data.frame(SampleSize = integer(), Cohens_d = numeric())

# å¾ªç¯é€æ­¥å¢åŠ æ ·æœ¬é‡è®¡ç®—æ•ˆåº”é‡
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects)

  summary_data <- sample_data %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT)

  if (all(c("Self", "Stranger") %in% colnames(summary_data))) {
    temp <- summary_data %>% filter(!is.na(Self) & !is.na(Stranger))
    if (nrow(temp) >= 2) {
      d <- cohen.d(temp$Stranger, temp$Self, paired = TRUE)$estimate
      result_df <- rbind(result_df, data.frame(SampleSize = n, Cohens_d = d))
    }
  }
}

# APA é£æ ¼å›¾å½¢è®¾ç½®
ggplot(result_df, aes(x = SampleSize, y = Cohens_d)) +
  geom_line(color = "black", size = 1.2) +
  geom_point(color = "black", size = 2.5) +
  theme_classic(base_size = 14, base_family = "serif") +
  labs(
    title = "Effect Size by Sample Size",
    x = "Sample Size (Number of Participants)",
    y = "Cohen's d (Self vs. Stranger)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank()
  )

ggsave("SPE_CohensD_by_SampleSize_APA-N.tiff", dpi = 300, width = 6, height = 4, units = "in")

```

```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–å¹¶ç­›é€‰ Matching æ¡ä»¶
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Matching", Standarlized_Identity %in% c("Self", "Stranger"))

# # è®¡ç®—æ¯ä¸ªè¢«è¯•çš„å¹³å‡ RTï¼ˆSelf vs. Strangerï¼‰
# per_subject_diff <- data_filtered %>%
#   group_by(Subject, Standarlized_Identity) %>%
#   summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
#   pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT) %>%
#   filter(!is.na(Self) & !is.na(Stranger)) %>%
#   mutate(Diff_SelfMinusStranger = Self - Stranger)
# 
# # ä¿å­˜ä¸º CSV
# write_csv(per_subject_diff, "Per_Subject_SPE_Diff.csv")

# è·å–å”¯ä¸€è¢«è¯•å¹¶æ‰“ä¹±é¡ºåº
set.seed(42)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

# è®¾å®šæ¯æ­¥çš„æ ·æœ¬é‡
sample_sizes <- seq(60, length(shuffled_subjects), by = 40)

# åˆå§‹åŒ–ç»“æœå­˜å‚¨
result_df <- data.frame(SampleSize = integer(), Cohens_d = numeric())

# å¾ªç¯é€æ­¥å¢åŠ æ ·æœ¬é‡è®¡ç®—æ•ˆåº”é‡
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects)

  summary_data <- sample_data %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT)

  if (all(c("Self", "Stranger") %in% colnames(summary_data))) {
    temp <- summary_data %>% filter(!is.na(Self) & !is.na(Stranger))
    if (nrow(temp) >= 2) {
      d <- cohen.d(temp$Stranger, temp$Self, paired = TRUE)$estimate
      result_df <- rbind(result_df, data.frame(SampleSize = n, Cohens_d = d))
    }
  }
}

# APA é£æ ¼å›¾å½¢è®¾ç½®
ggplot(result_df, aes(x = SampleSize, y = Cohens_d)) +
  geom_line(color = "black", size = 1.2) +
  geom_point(color = "black", size = 2.5) +
  theme_classic(base_size = 14, base_family = "serif") +
  labs(
    title = "Effect Size (Cohen's d) by Sample Size (Matching Condition)",
    x = "Sample Size (Number of Participants)",
    y = "Cohen's d (Self vs. Stranger)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank()
  )

ggsave("SPE_CohensD_by_SampleSize_APA-M.tiff", dpi = 300, width = 6, height = 4, units = "in")

```

###Bootstrap Nonmatching 
```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–æ•°æ®
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Nonmatching", Standarlized_Identity %in% c("Self", "Stranger"))

set.seed(42)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

sample_sizes <- seq(10, length(shuffled_subjects), by = 40)

# åˆå§‹åŒ–ç»“æœåˆ—è¡¨
boot_results <- list()
B <- 1000  # Bootstrapæ¬¡æ•°

# Bootstrapping
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects) %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT) %>%
    filter(!is.na(Self) & !is.na(Stranger))

  # è·³è¿‡å°‘äº2ä¸ªæ•°æ®ç‚¹çš„
  if (nrow(sample_data) < 2) next

  d_values <- replicate(B, {
    boot_sample <- sample_n(sample_data, size = nrow(sample_data), replace = TRUE)
    cohen.d(boot_sample$Stranger, boot_sample$Self, paired = TRUE)$estimate
  })

  boot_results[[length(boot_results) + 1]] <- data.frame(
    SampleSize = n,
    Mean_d = mean(d_values, na.rm = TRUE),
    SE = sd(d_values, na.rm = TRUE),
    CI_lower = quantile(d_values, 0.025, na.rm = TRUE),
    CI_upper = quantile(d_values, 0.975, na.rm = TRUE)
  )
}

# åˆå¹¶æ‰€æœ‰ç»“æœ
result_df <- bind_rows(boot_results)

# ç»˜å›¾ï¼ˆå«ç½®ä¿¡åŒºé—´ + å‚è€ƒçº¿ï¼‰
ggplot(result_df, aes(x = SampleSize, y = Mean_d)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), fill = "gray80", alpha = 0.5) +
  geom_line(color = "black", size = 1.2) +
  geom_point(color = "black", size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +  # å‚è€ƒçº¿
  theme_classic(base_size = 14, base_family = "serif") +
  labs(
    title = "Effect Size (Cohen's d) by Sample Size\nwith 95% CI (Nonmatching Condition)",
    x = "Sample Size (Number of Participants)",
    y = "Cohen's d (Self vs. Stranger)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank()
  )

ggsave("Cohens_d_with_CI_APA-BN.tiff", dpi = 300, width = 6, height = 4, units = "in")

```

###Bootstrap Matching
```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–æ•°æ®
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

data_filtered <- data %>%
  filter(Matching == "Matching", Standarlized_Identity %in% c("Stranger","Self"))

set.seed(44)
all_subjects <- unique(data_filtered$Subject)
shuffled_subjects <- sample(all_subjects)

sample_sizes <- seq(60, length(shuffled_subjects), by = 40)

# åˆå§‹åŒ–ç»“æœåˆ—è¡¨
boot_results <- list()
B <- 1000  # Bootstrapæ¬¡æ•°

# Bootstrapping
for (n in sample_sizes) {
  selected_subjects <- shuffled_subjects[1:n]
  sample_data <- data_filtered %>%
    filter(Subject %in% selected_subjects) %>%
    group_by(Subject, Standarlized_Identity) %>%
    summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT) %>%
    filter(!is.na(Self) & !is.na(Stranger))

  # è·³è¿‡å°‘äº2ä¸ªæ•°æ®ç‚¹çš„
  if (nrow(sample_data) < 2) next

  d_values <- replicate(B, {
    boot_sample <- sample_n(sample_data, size = nrow(sample_data), replace = TRUE)
    cohen.d(boot_sample$Stranger,boot_sample$Self, paired = TRUE)$estimate
  })

  boot_results[[length(boot_results) + 1]] <- data.frame(
    SampleSize = n,
    Mean_d = mean(d_values, na.rm = TRUE),
    SE = sd(d_values, na.rm = TRUE),
    CI_lower = quantile(d_values, 0.025, na.rm = TRUE),
    CI_upper = quantile(d_values, 0.975, na.rm = TRUE)
  )
}

# åˆå¹¶æ‰€æœ‰ç»“æœ
result_df <- bind_rows(boot_results)

# ç»˜å›¾ï¼ˆå«ç½®ä¿¡åŒºé—´ï¼‰
ggplot(result_df, aes(x = SampleSize, y = Mean_d)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), fill = "gray80", alpha = 0.5) +
  geom_line(color = "black", size = 1.2) +
  geom_point(color = "black", size = 2.5) +
  theme_classic(base_size = 14, base_family = "serif") +
  labs(
    title = "Effect Size (Cohen's d) by Sample Size\nwith 95% CI (Matching Condition)",
    x = "Sample Size (Number of Participants)",
    y = "Cohen's d (Self vs. Stranger)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank()
  )
ggsave("Cohens_d_with_CI_APA-BM.tiff", dpi = 300, width = 6, height = 4, units = "in")

```

###Combined
```{r}
library(dplyr)
library(effsize)
library(ggplot2)
library(readr)
library(tidyr)

# è¯»å–æ•°æ®
data <- read_csv("../3_Code/Processed_Data_Filtered_with_logRT.csv", show_col_types = FALSE)

# å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥Matchingæ¡ä»¶ï¼Œè¿”å›bootstrapç»“æœæ•°æ®æ¡†
bootstrap_effect_size <- function(match_condition, seed, sample_start = 10, sample_by = 40) {
  data_filtered <- data %>%
    filter(Matching == match_condition, Standarlized_Identity %in% c("Self", "Stranger"))
  
  set.seed(seed)
  all_subjects <- unique(data_filtered$Subject)
  shuffled_subjects <- sample(all_subjects)
  
  # è®¾ç½®æ ·æœ¬é‡åºåˆ—ï¼ŒMatchingæ¡ä»¶èµ·å§‹æ ·æœ¬é‡å¯è°ƒæ•´
  sample_sizes <- seq(sample_start, length(shuffled_subjects), by = sample_by)
  
  boot_results <- list()
  B <- 1000
  
  for (n in sample_sizes) {
    selected_subjects <- shuffled_subjects[1:n]
    sample_data <- data_filtered %>%
      filter(Subject %in% selected_subjects) %>%
      group_by(Subject, Standarlized_Identity) %>%
      summarise(MeanRT = mean(RT_ms, na.rm = TRUE), .groups = "drop") %>%
      pivot_wider(names_from = Standarlized_Identity, values_from = MeanRT) %>%
      filter(!is.na(Self) & !is.na(Stranger))
    
    if (nrow(sample_data) < 2) next
    
    d_values <- replicate(B, {
      boot_sample <- sample_n(sample_data, size = nrow(sample_data), replace = TRUE)
      cohen.d(boot_sample$Stranger, boot_sample$Self, paired = TRUE)$estimate
    })
    
    boot_results[[length(boot_results) + 1]] <- data.frame(
      SampleSize = n,
      Mean_d = mean(d_values, na.rm = TRUE),
      SE = sd(d_values, na.rm = TRUE),
      CI_lower = quantile(d_values, 0.025, na.rm = TRUE),
      CI_upper = quantile(d_values, 0.975, na.rm = TRUE)
    )
  }
  
  df <- bind_rows(boot_results)
  df$Condition <- match_condition
  return(df)
}

# åˆ†åˆ«è®¡ç®—ä¸¤ä¸ªæ¡ä»¶çš„ç»“æœ
boot_nonmatching <- bootstrap_effect_size("Nonmatching", seed = 44, sample_start = 10, sample_by = 40)
boot_matching <- bootstrap_effect_size("Matching", seed = 44, sample_start = 10, sample_by = 40)

# åˆå¹¶ç»“æœ
result_df <- bind_rows(boot_nonmatching, boot_matching)

# ç»˜å›¾ï¼ŒåŒºåˆ†æ¡ä»¶é¢œè‰²
ggplot(result_df, aes(x = SampleSize, y = Mean_d, color = Condition, fill = Condition)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), alpha = 0.2, color = NA) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = c("Nonmatching" = "firebrick", "Matching" = "dodgerblue")) +
  scale_fill_manual(values = c("Nonmatching" = "firebrick", "Matching" = "dodgerblue")) +
  theme_classic(base_size = 14, base_family = "serif") +
  labs(
    title = "Effect Size (Cohen's d) by Sample Size with 95% CI",
    x = "Sample Size (Number of Participants)",
    y = "Cohen's d (Self vs. Stranger)",
    color = "Condition",
    fill = "Condition"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black"),
    panel.grid = element_blank(),
    legend.position = "top"
  )

# ä¿å­˜å›¾åƒ
ggsave("Cohens_d_with_CI_APA_Combined.tiff", dpi = 300, width = 7, height = 5, units = "in")

```



###Mismatch
```{r}
data <- read.csv("Processed_Data.csv")

data$Standarlized_Identity <- as.factor(data$Standarlized_Identity)

## æ’é™¤è¢«è¯•å­˜åœ¨æŸä¸ªIdentityæ­£ç¡®ç‡ä½äº50%

subjects_to_exclude <- data %>%
  group_by(Subject, Standarlized_Identity) %>%
  summarise(mean_acc = mean(ACC, na.rm = TRUE), .groups = "drop") %>%
  filter(mean_acc < 0.5) %>%
  distinct(Subject)

# æ’é™¤è¿™äº›è¢«è¯•
data_filtered <- data %>%
  anti_join(subjects_to_exclude, by = "Subject")

unique(data$Source)

levels(data$Standarlized_Identity)

data_mis <- filter(data_filtered, Matching == 'Nomatching', RT_ms >= 200)
data_RT_mis <- filter(data_mis, ACC == 1, RT_ms >= 200, RT_ms <= 5000)

data_RT_mis$log_RT_ms <- log(data_RT_mis$RT_ms)
```

```{r}
# è¯»å–æ•°æ®
library(dplyr)
library(ggplot2)
library(tidyr)
library(effsize)

set.seed(990102)

# =============================================================================
# æ•°æ®é¢„å¤„ç†å‡½æ•°
# =============================================================================

# é€šç”¨çš„è¢«è¯•ç­›é€‰å‡½æ•°
filter_valid_subjects <- function(data, identity_column) {
  subject_summary <- data %>%
    group_by(Subject) %>%
    summarise(
      unique_identities = list(unique(!!sym(identity_column)[!is.na(!!sym(identity_column))])),
      identity_count = length(unique(!!sym(identity_column)[!is.na(!!sym(identity_column))])),
      has_self = any(!!sym(identity_column) == "Self", na.rm = TRUE),
      has_stranger = any(!!sym(identity_column) == "Stranger", na.rm = TRUE),
      total_trials = n(),
      .groups = 'drop'
    ) %>%
    mutate(
      meets_criteria = has_self & has_stranger & identity_count >= 3
    )
  
  valid_subjects <- subject_summary$Subject[subject_summary$meets_criteria]
  print(paste("ä¿ç•™çš„è¢«è¯•æ•°é‡:", length(valid_subjects)))
  
  return(valid_subjects)
}

# é€šç”¨çš„æ•°æ®å¤„ç†å‡½æ•°
process_data <- function(data, analysis_type = "Shape") {
  
  if(analysis_type == "Shape") {
    identity_col <- "Standarlized_Identity" 
    label_col <- "Label_Identity"
  } else {
    identity_col <- "Label_Identity"
    label_col <- "Standarlized_Identity"
  }
  
  # ç­›é€‰è¢«è¯•
  valid_subjects <- filter_valid_subjects(data, identity_col)
  
  # å¤„ç†æ•°æ®
  data_processed <- data %>%
    filter(Subject %in% valid_subjects) %>%
    mutate(
      Primary = case_when(
        !!sym(identity_col) == "Self" ~ "Self",
        !!sym(identity_col) == "Stranger" ~ "Stranger", 
        TRUE ~ "Other"
      ),
      Secondary = case_when(
        !!sym(label_col) == "Self" ~ "Self",
        !!sym(label_col) == "Stranger" ~ "Stranger",
        TRUE ~ "Other"
      )
    ) %>%
    filter(
      Primary == "Self" |
        (Primary == "Stranger" & Secondary != "Self") |
        Primary == "Other"
    )
  
  return(data_processed)
}

# =============================================================================
# Cohen's d è®¡ç®—å‡½æ•°
# =============================================================================

calculate_cohens_d <- function(data, analysis_type = "Shape", measure = "RT", min_trials = 2) {
  
  # RTåˆ†æéœ€è¦logè½¬æ¢
  if(measure == "RT") {
    data$log_RT_ms <- log(data$RT_ms)
    dependent_var <- "log_RT_ms"
  } else {
    dependent_var <- "ACC"
    min_trials <- 5  # ACCéœ€è¦æ›´å¤šè¯•æ¬¡
  }
  
  # ç­›é€‰æ•°æ®
  data_analysis <- data %>%
    filter(Primary %in% c("Self", "Stranger"))
  
  # æ£€æŸ¥è¢«è¯•æ•°æ®å®Œæ•´æ€§
  subject_check <- data_analysis %>%
    group_by(Subject) %>%
    summarise(
      has_self = any(Primary == "Self"),
      has_stranger = any(Primary == "Stranger"), 
      n_self = sum(Primary == "Self"),
      n_stranger = sum(Primary == "Stranger"),
      .groups = 'drop'
    ) %>%
    mutate(
      complete_data = has_self & has_stranger & n_self >= min_trials & n_stranger >= min_trials
    )
  
  complete_subjects <- subject_check$Subject[subject_check$complete_data]
  print(paste("å‚ä¸Cohen's dè®¡ç®—çš„è¢«è¯•æ•°é‡:", length(complete_subjects)))
  
  # è®¡ç®—Cohen's d
  cohens_d_results <- data.frame()
  
  for(subject_id in complete_subjects) {
    subject_data <- data_analysis[data_analysis$Subject == subject_id, ]
    
    self_data <- subject_data[subject_data$Primary == "Self", dependent_var]
    stranger_data <- subject_data[subject_data$Primary == "Stranger", dependent_var]
    
    # ç§»é™¤NAå€¼
    self_data <- self_data[!is.na(self_data)]
    stranger_data <- stranger_data[!is.na(stranger_data)]
    
    tryCatch({
      # RT: Stranger - Self; ACC: Self - Stranger
      if(measure == "RT") {
        cohens_d_value <- cohen.d(stranger_data, self_data)$estimate
      } else {
        cohens_d_value <- cohen.d(self_data, stranger_data)$estimate  
      }
      
      cohens_d_results <- rbind(cohens_d_results, data.frame(
        Subject = subject_id,
        Cohens_d = cohens_d_value,
        n_self = length(self_data),
        n_stranger = length(stranger_data),
        mean_self = mean(self_data),
        mean_stranger = mean(stranger_data),
        stringsAsFactors = FALSE
      ))
      
    }, error = function(e) {
      warning(paste("è¢«è¯•", subject_id, "è®¡ç®—å¤±è´¥"))
    })
  }
  
  if(nrow(cohens_d_results) > 0) {
    mean_cohens_d <- mean(cohens_d_results$Cohens_d, na.rm = TRUE)
    print(paste(analysis_type, measure, "Cohen's då¹³å‡å€¼:", round(mean_cohens_d, 4)))
  }
  
  return(list(
    individual_results = cohens_d_results,
    mean_cohens_d = mean_cohens_d
  ))
}

# =============================================================================
# Bootstrapåˆ†æå‡½æ•°
# =============================================================================

bootstrap_analysis <- function(cohens_d_result, condition_name, B = 5000) {
  
  if(is.list(cohens_d_result) && "individual_results" %in% names(cohens_d_result)) {
    cohend_data <- cohens_d_result$individual_results
  } else {
    cohend_data <- cohens_d_result
  }
  
  cohend_clean <- cohend_data[!is.na(cohend_data$Cohens_d), ]
  
  if(nrow(cohend_clean) == 0) return(NULL)
  
  # ç”Ÿæˆæ ·æœ¬é‡åºåˆ—
  max_n <- nrow(cohend_clean)
  if(max_n <= 10) {
    sample_sizes <- 2:max_n
  } else {
    sample_sizes <- seq(from = 2, to = max_n, by = max(1, floor(max_n/15)))
    sample_sizes <- c(sample_sizes, max_n)
  }
  sample_sizes <- unique(sort(sample_sizes))
  
  # Bootstrapåˆ†æ
  set.seed(123)
  shuffled_data <- cohend_clean[sample(nrow(cohend_clean)), ]
  
  boot_results <- list()
  
  for (n in sample_sizes) {
    if (n > nrow(shuffled_data)) next
    
    selected_cohend <- shuffled_data$Cohens_d[1:n]
    if (length(selected_cohend) < 2) next
    
    d_values <- replicate(B, {
      boot_sample <- sample(selected_cohend, size = length(selected_cohend), replace = TRUE)
      mean(boot_sample, na.rm = TRUE)
    })
    
    boot_results[[length(boot_results) + 1]] <- data.frame(
      SampleSize = n,
      Identity = condition_name,
      Mean_d = mean(d_values, na.rm = TRUE),
      SE = sd(d_values, na.rm = TRUE),
      CI_lower = quantile(d_values, 0.025, na.rm = TRUE),
      CI_upper = quantile(d_values, 0.975, na.rm = TRUE),
      stringsAsFactors = FALSE
    )
  }
  
  return(bind_rows(boot_results))
}

# åˆå¹¶Bootstrapç»“æœ
combined_bootstrap_analysis <- function(shape_result, label_result, B = 5000) {
  
  shape_bootstrap <- bootstrap_analysis(shape_result, "Shape", B)
  label_bootstrap <- bootstrap_analysis(label_result, "Label", B)
  
  combined_results <- bind_rows(shape_bootstrap, label_bootstrap)
  
  if(nrow(combined_results) > 0) {
    combined_results$is_significant <- combined_results$CI_lower > 0
  }
  
  return(combined_results)
}

# =============================================================================
# ç»˜å›¾å‡½æ•°
# =============================================================================

create_bootstrap_plot <- function(combined_results, measure = "RT") {
  
  identity_colors <- c("Shape" = "#2E86AB", "Label" = "#A23B72")
  
  # æ ¹æ®æµ‹é‡ç±»å‹è®¾ç½®æ ‡é¢˜å’ŒYè½´æ ‡ç­¾
  if(measure == "RT") {
    y_label <- "Cohen's d (Stranger - Self)"
    title <- "Bootstrap Power Analysis of Reaction Time"
  } else {
    y_label <- "Cohen's d (Self - Stranger)"  
    title <- "Bootstrap Power Analysis of Accuracy"
  }
  
  p <- ggplot(combined_results, aes(x = SampleSize, y = Mean_d, color = Identity, fill = Identity)) +
    geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), alpha = 0.2, color = NA) +
    geom_line(size = 1.2) +
    geom_point(size = 2.5) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", alpha = 0.7) +
    scale_color_manual(values = identity_colors) +
    scale_fill_manual(values = identity_colors) +
    scale_y_continuous(
      expand = expansion(mult = c(0.02, 0.02)),
      breaks = scales::pretty_breaks(n = 8)
    ) +
    scale_x_continuous(
      expand = expansion(mult = c(0.01, 0.01)),
      breaks = scales::pretty_breaks(n = 8)
    ) +
    labs(
      x = "Sample Size (Number of Participants)",
      y = y_label,
      color = "Social Identity Category",
      fill = "Social Identity Category",
      title = title
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 25, face = "bold", family = "Times New Roman"),
      legend.text = element_text(size = 25, family = "Times New Roman"),
      axis.title.x = element_text(size = 35, face = "bold", color = "black", 
                                  family = "Times New Roman", margin = margin(t = 20)),
      axis.title.y = element_text(size = 35, color = "black", face = "bold", 
                                  family = "Times New Roman", angle = 90, margin = margin(r = 20)),
      axis.text = element_text(size = 35, color = "black", family = "Times New Roman"),
      axis.line = element_line(color = "black", size = 0.7),
      axis.ticks = element_line(color = "black", size = 0.7),
      panel.grid = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      plot.title = element_text(size = 30, hjust = 0.5, family = "Times New Roman")
    )
  
  return(p)
}

# =============================================================================
# ä¸»åˆ†ææµç¨‹
# =============================================================================

run_complete_analysis <- function(data_filtered, data_rt_mis, save_plots = TRUE) {
  
  print("=== å¼€å§‹å®Œæ•´çš„RTå’ŒACCåˆ†æ ===")
  
  # RTåˆ†æ
  print("\nç¬¬ä¸€æ­¥ï¼šååº”æ—¶é—´åˆ†æ")
  rt_shape_data <- process_data(data_rt_mis, "Shape")  
  rt_label_data <- process_data(data_rt_mis, "Label")
  
  rt_shape_cohens <- calculate_cohens_d(rt_shape_data, "Shape", "RT")
  rt_label_cohens <- calculate_cohens_d(rt_label_data, "Label", "RT") 
  
  rt_bootstrap <- combined_bootstrap_analysis(rt_shape_cohens, rt_label_cohens, B = 5000)
  rt_plot <- create_bootstrap_plot(rt_bootstrap, "RT")
  
  # ACCåˆ†æ  
  print("\nç¬¬äºŒæ­¥ï¼šå‡†ç¡®ç‡åˆ†æ")
  acc_shape_data <- process_data(data_filtered, "Shape")
  acc_label_data <- process_data(data_filtered, "Label")
  
  acc_shape_cohens <- calculate_cohens_d(acc_shape_data, "Shape", "ACC")
  acc_label_cohens <- calculate_cohens_d(acc_label_data, "Label", "ACC")
  
  acc_bootstrap <- combined_bootstrap_analysis(acc_shape_cohens, acc_label_cohens, B = 5000)
  acc_plot <- create_bootstrap_plot(acc_bootstrap, "ACC")
  
  # æ˜¾ç¤ºå›¾å½¢
  print("\nç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤ºç»“æœ")
  print("ååº”æ—¶é—´å›¾:")
  print(rt_plot)
  cat("\næŒ‰å›è½¦é”®æŸ¥çœ‹å‡†ç¡®ç‡å›¾...")
  readline()
  print("å‡†ç¡®ç‡å›¾:")
  print(acc_plot)
  
  # ä¿å­˜å›¾å½¢
  if(save_plots) {
    ggsave("Bootstrap_RT_Analysis.pdf", rt_plot, width = 20, height = 10, device = "pdf")
    ggsave("Bootstrap_ACC_Analysis.pdf", acc_plot, width = 20, height = 10, device = "pdf")
    print("\nå›¾å½¢å·²ä¿å­˜ä¸ºPDFæ–‡ä»¶")
  }
  
  # ç»“æœæ€»ç»“
  print("\n=== åˆ†æå®Œæˆ ===")
  print(paste("RT Shape Cohen's då¹³å‡å€¼:", round(rt_shape_cohens$mean_cohens_d, 4)))
  print(paste("RT Label Cohen's då¹³å‡å€¼:", round(rt_label_cohens$mean_cohens_d, 4)))
  print(paste("ACC Shape Cohen's då¹³å‡å€¼:", round(acc_shape_cohens$mean_cohens_d, 4)))
  print(paste("ACC Label Cohen's då¹³å‡å€¼:", round(acc_label_cohens$mean_cohens_d, 4)))
  
  return(list(
    rt_plot = rt_plot,
    acc_plot = acc_plot,
    rt_bootstrap = rt_bootstrap,
    acc_bootstrap = acc_bootstrap,
    rt_shape_cohens = rt_shape_cohens,
    rt_label_cohens = rt_label_cohens,
    acc_shape_cohens = acc_shape_cohens,
    acc_label_cohens = acc_label_cohens
  ))
}

# =============================================================================
# ä½¿ç”¨æ–¹æ³•
# =============================================================================

print("=== ç²¾ç®€ç‰ˆRTå’ŒACCåˆ†æä»£ç å·²å‡†å¤‡å°±ç»ª ===")
print("\næ•°æ®å‡†å¤‡:")
print("1. data_filtered: åŒ…å«æ‰€æœ‰è¯•æ¬¡çš„æ•°æ®(ç”¨äºACCåˆ†æ)")
print("2. data_rt_mis: åªåŒ…å«æ­£ç¡®è¯•æ¬¡çš„æ•°æ®(ç”¨äºRTåˆ†æ)")
print("\nè¿è¡Œåˆ†æ:")
print("results <- run_complete_analysis(data_filtered, data_rt_mis)")
print("\nå¿«é€Ÿä½¿ç”¨:")

# æ•°æ®é¢„å¤„ç†
data_mis <- filter(data_filtered, Matching == 'Nonmatching', RT_ms >= 200, RT_ms <= 5000)
data_RT_mis <- filter(data_mis, ACC == 1)
data_RT_mis$log_RT_ms <- log(data_RT_mis$RT_ms)

# è¿è¡Œå®Œæ•´åˆ†æ
results <- run_complete_analysis(data_mis, data_RT_mis)
```

```{r}
# =============================================================================
# æ•°æ®é¢„å¤„ç†å‡½æ•°
# =============================================================================

# é€šç”¨çš„è¢«è¯•ç­›é€‰å‡½æ•°
filter_valid_subjects <- function(data, identity_column) {
  
  # ä½¿ç”¨æ ‡å‡†çš„dplyrè¯­æ³•ï¼Œé¿å…!!sym()çš„é—®é¢˜
  subject_summary <- data %>%
    group_by(Subject) %>%
    summarise(
      unique_identities = if(identity_column == "Standarlized_Identity") {
        list(unique(Standarlized_Identity[!is.na(Standarlized_Identity)]))
      } else {
        list(unique(Label_Identity[!is.na(Label_Identity)]))
      },
      identity_count = if(identity_column == "Standarlized_Identity") {
        length(unique(Standarlized_Identity[!is.na(Standarlized_Identity)]))
      } else {
        length(unique(Label_Identity[!is.na(Label_Identity)]))
      },
      has_self = if(identity_column == "Standarlized_Identity") {
        any(Standarlized_Identity == "Self", na.rm = TRUE)
      } else {
        any(Label_Identity == "Self", na.rm = TRUE)
      },
      has_stranger = if(identity_column == "Standarlized_Identity") {
        any(Standarlized_Identity == "Stranger", na.rm = TRUE)
      } else {
        any(Label_Identity == "Stranger", na.rm = TRUE)
      },
      total_trials = n(),
      .groups = 'drop'
    ) %>%
    mutate(
      meets_criteria = has_self & has_stranger & identity_count >= 3
    )
  
  valid_subjects <- subject_summary$Subject[subject_summary$meets_criteria]
  print(paste("ä¿ç•™çš„è¢«è¯•æ•°é‡:", length(valid_subjects)))
  
  return(valid_subjects)
}

# é€šç”¨çš„æ•°æ®å¤„ç†å‡½æ•°
process_data <- function(data, analysis_type = "Shape") {
  
  # ç­›é€‰è¢«è¯•
  if(analysis_type == "Shape") {
    valid_subjects <- filter_valid_subjects(data, "Standarlized_Identity")
  } else {
    valid_subjects <- filter_valid_subjects(data, "Label_Identity")
  }
  
  # å¤„ç†æ•°æ®
  if(analysis_type == "Shape") {
    data_processed <- data %>%
      filter(Subject %in% valid_subjects) %>%
      mutate(
        Primary = case_when(
          Standarlized_Identity == "Self" ~ "Self",
          Standarlized_Identity == "Stranger" ~ "Stranger", 
          TRUE ~ "Other"
        ),
        Secondary = case_when(
          Label_Identity == "Self" ~ "Self",
          Label_Identity == "Stranger" ~ "Stranger",
          TRUE ~ "Other"
        )
      ) %>%
      filter(
        Primary == "Self" |
          (Primary == "Stranger" & Secondary != "Self") |
          Primary == "Other"
      )
  } else {
    data_processed <- data %>%
      filter(Subject %in% valid_subjects) %>%
      mutate(
        Primary = case_when(
          Label_Identity == "Self" ~ "Self",
          Label_Identity == "Stranger" ~ "Stranger", 
          TRUE ~ "Other"
        ),
        Secondary = case_when(
          Standarlized_Identity == "Self" ~ "Self",
          Standarlized_Identity == "Stranger" ~ "Stranger",
          TRUE ~ "Other"
        )
      ) %>%
      filter(
        Primary == "Self" |
          (Primary == "Stranger" & Secondary != "Self") |
          Primary == "Other"
      )
  }
  
  return(data_processed)
}

# =============================================================================
# Cohen's d è®¡ç®—å‡½æ•°
# =============================================================================

calculate_cohens_d <- function(data, analysis_type = "Shape", measure = "RT", min_trials = 2) {
  
  # RTåˆ†æéœ€è¦logè½¬æ¢
  if(measure == "RT") {
    if(!"log_RT_ms" %in% names(data)) {
      data$log_RT_ms <- log(data$RT_ms)
    }
    dependent_var <- "log_RT_ms"
  } else {
    dependent_var <- "ACC"
    min_trials <- 5  # ACCéœ€è¦æ›´å¤šè¯•æ¬¡
  }
  
  # ç­›é€‰æ•°æ®
  data_analysis <- data %>%
    filter(Primary %in% c("Self", "Stranger"))
  
  # æ£€æŸ¥è¢«è¯•æ•°æ®å®Œæ•´æ€§
  subject_check <- data_analysis %>%
    group_by(Subject) %>%
    summarise(
      has_self = any(Primary == "Self"),
      has_stranger = any(Primary == "Stranger"), 
      n_self = sum(Primary == "Self"),
      n_stranger = sum(Primary == "Stranger"),
      .groups = 'drop'
    ) %>%
    mutate(
      complete_data = has_self & has_stranger & n_self >= min_trials & n_stranger >= min_trials
    )
  
  complete_subjects <- subject_check$Subject[subject_check$complete_data]
  print(paste("å‚ä¸Cohen's dè®¡ç®—çš„è¢«è¯•æ•°é‡:", length(complete_subjects)))
  
  if(length(complete_subjects) == 0) {
    warning("æ²¡æœ‰è¢«è¯•æ»¡è¶³æ¡ä»¶ï¼")
    return(list(individual_results = data.frame(), mean_cohens_d = NA))
  }
  
  # è®¡ç®—Cohen's d
  cohens_d_results <- data.frame()
  
  for(subject_id in complete_subjects) {
    subject_data <- data_analysis[data_analysis$Subject == subject_id, ]
    
    self_data <- subject_data[subject_data$Primary == "Self", dependent_var]
    stranger_data <- subject_data[subject_data$Primary == "Stranger", dependent_var]
    
    # ç§»é™¤NAå€¼
    self_data <- self_data[!is.na(self_data)]
    stranger_data <- stranger_data[!is.na(stranger_data)]
    
    tryCatch({
      # RT: Stranger - Self; ACC: Self - Stranger
      if(measure == "RT") {
        cohens_d_value <- cohen.d(stranger_data, self_data)$estimate
      } else {
        cohens_d_value <- cohen.d(self_data, stranger_data)$estimate  
      }
      
      cohens_d_results <- rbind(cohens_d_results, data.frame(
        Subject = subject_id,
        Cohens_d = cohens_d_value,
        n_self = length(self_data),
        n_stranger = length(stranger_data),
        mean_self = mean(self_data),
        mean_stranger = mean(stranger_data),
        stringsAsFactors = FALSE
      ))
      
    }, error = function(e) {
      warning(paste("è¢«è¯•", subject_id, "è®¡ç®—å¤±è´¥:", e$message))
    })
  }
  
  if(nrow(cohens_d_results) > 0) {
    mean_cohens_d <- mean(cohens_d_results$Cohens_d, na.rm = TRUE)
    print(paste(analysis_type, measure, "Cohen's då¹³å‡å€¼:", round(mean_cohens_d, 4)))
  } else {
    mean_cohens_d <- NA
    print(paste(analysis_type, measure, "æ²¡æœ‰æˆåŠŸè®¡ç®—Cohen's d"))
  }
  
  return(list(
    individual_results = cohens_d_results,
    mean_cohens_d = mean_cohens_d
  ))
}

# =============================================================================
# Bootstrapåˆ†æå‡½æ•°
# =============================================================================

bootstrap_analysis <- function(cohens_d_result, condition_name, B = 5000) {
  
  if(is.list(cohens_d_result) && "individual_results" %in% names(cohens_d_result)) {
    cohend_data <- cohens_d_result$individual_results
  } else {
    cohend_data <- cohens_d_result
  }
  
  if(is.null(cohend_data) || nrow(cohend_data) == 0) {
    warning(paste("æ²¡æœ‰", condition_name, "çš„Cohen's dæ•°æ®"))
    return(NULL)
  }
  
  cohend_clean <- cohend_data[!is.na(cohend_data$Cohens_d), ]
  
  if(nrow(cohend_clean) == 0) {
    warning(paste(condition_name, "æ²¡æœ‰æœ‰æ•ˆçš„Cohen's då€¼"))
    return(NULL)
  }
  
  # ç”Ÿæˆæ ·æœ¬é‡åºåˆ—
  max_n <- nrow(cohend_clean)
  if(max_n <= 10) {
    sample_sizes <- 2:max_n
  } else {
    sample_sizes <- seq(from = 2, to = max_n, by = max(1, floor(max_n/15)))
    sample_sizes <- c(sample_sizes, max_n)
  }
  sample_sizes <- unique(sort(sample_sizes))
  
  # Bootstrapåˆ†æ
  set.seed(123)
  shuffled_data <- cohend_clean[sample(nrow(cohend_clean)), ]
  
  boot_results <- list()
  
  for (n in sample_sizes) {
    if (n > nrow(shuffled_data)) next
    
    selected_cohend <- shuffled_data$Cohens_d[1:n]
    if (length(selected_cohend) < 2) next
    
    d_values <- replicate(B, {
      boot_sample <- sample(selected_cohend, size = length(selected_cohend), replace = TRUE)
      mean(boot_sample, na.rm = TRUE)
    })
    
    boot_results[[length(boot_results) + 1]] <- data.frame(
      SampleSize = n,
      Identity = condition_name,
      Mean_d = mean(d_values, na.rm = TRUE),
      SE = sd(d_values, na.rm = TRUE),
      CI_lower = quantile(d_values, 0.025, na.rm = TRUE),
      CI_upper = quantile(d_values, 0.975, na.rm = TRUE),
      stringsAsFactors = FALSE
    )
  }
  
  if(length(boot_results) > 0) {
    return(bind_rows(boot_results))
  } else {
    return(NULL)
  }
}

# åˆå¹¶Bootstrapç»“æœ
combined_bootstrap_analysis <- function(shape_result, label_result, B = 5000) {
  
  shape_bootstrap <- bootstrap_analysis(shape_result, "Shape", B)
  label_bootstrap <- bootstrap_analysis(label_result, "Label", B)
  
  # åˆå¹¶æœ‰æ•ˆç»“æœ
  valid_results <- list()
  if(!is.null(shape_bootstrap)) valid_results <- c(valid_results, list(shape_bootstrap))
  if(!is.null(label_bootstrap)) valid_results <- c(valid_results, list(label_bootstrap))
  
  if(length(valid_results) == 0) {
    warning("æ²¡æœ‰æœ‰æ•ˆçš„Bootstrapç»“æœ")
    return(NULL)
  }
  
  combined_results <- bind_rows(valid_results)
  
  if(nrow(combined_results) > 0) {
    combined_results$is_significant <- combined_results$CI_lower > 0
  }
  
  return(combined_results)
}

# =============================================================================
# ç»˜å›¾å‡½æ•°
# =============================================================================

create_bootstrap_plot <- function(combined_results, measure = "RT") {
  
  if(is.null(combined_results) || nrow(combined_results) == 0) {
    print("æ²¡æœ‰æ•°æ®å¯ç»˜å›¾")
    return(NULL)
  }
  
  identity_colors <- c("Shape" = "#2E86AB", "Label" = "#A23B72")
  
  # æ ¹æ®æµ‹é‡ç±»å‹è®¾ç½®æ ‡é¢˜å’ŒYè½´æ ‡ç­¾
  if(measure == "RT") {
    y_label <- "Cohen's d (Stranger - Self)"
    title <- "Bootstrap Power Analysis of Reaction Time"
  } else {
    y_label <- "Cohen's d (Self - Stranger)"  
    title <- "Bootstrap Power Analysis of Accuracy"
  }
  
  p <- ggplot(combined_results, aes(x = SampleSize, y = Mean_d, color = Identity, fill = Identity)) +
    geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), alpha = 0.2, color = NA) +
    geom_line(size = 1.2) +
    geom_point(size = 2.5) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", alpha = 0.7) +
    scale_color_manual(values = identity_colors) +
    scale_fill_manual(values = identity_colors) +
    scale_y_continuous(
      expand = expansion(mult = c(0.02, 0.02)),
      breaks = scales::pretty_breaks(n = 8)
    ) +
    scale_x_continuous(
      expand = expansion(mult = c(0.01, 0.01)),
      breaks = scales::pretty_breaks(n = 8)
    ) +
    labs(
      x = "Sample Size (Number of Participants)",
      y = y_label,
      color = "Social Identity Category",
      fill = "Social Identity Category",
      title = title
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 25, face = "bold", family = "Times New Roman"),
      legend.text = element_text(size = 25, family = "Times New Roman"),
      axis.title.x = element_text(size = 35, face = "bold", color = "black", 
                                  family = "Times New Roman", margin = margin(t = 20)),
      axis.title.y = element_text(size = 35, color = "black", face = "bold", 
                                  family = "Times New Roman", angle = 90, margin = margin(r = 20)),
      axis.text = element_text(size = 35, color = "black", family = "Times New Roman"),
      axis.line = element_line(color = "black", size = 0.7),
      axis.ticks = element_line(color = "black", size = 0.7),
      panel.grid = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      plot.title = element_text(size = 30, hjust = 0.5, family = "Times New Roman")
    )
  
  return(p)
}

# =============================================================================
# ä¸»åˆ†ææµç¨‹
# =============================================================================

run_complete_analysis <- function(data_filtered, data_rt_mis, save_plots = TRUE) {
  
  print("=== å¼€å§‹å®Œæ•´çš„RTå’ŒACCåˆ†æ ===")
  
  # RTåˆ†æ
  print("\nç¬¬ä¸€æ­¥ï¼šååº”æ—¶é—´åˆ†æ")
  print("å¤„ç†Shapeæ•°æ®...")
  rt_shape_data <- process_data(data_rt_mis, "Shape")  
  print("å¤„ç†Labelæ•°æ®...")
  rt_label_data <- process_data(data_rt_mis, "Label")
  
  print("è®¡ç®—RT Cohen's d...")
  rt_shape_cohens <- calculate_cohens_d(rt_shape_data, "Shape", "RT")
  rt_label_cohens <- calculate_cohens_d(rt_label_data, "Label", "RT") 
  
  print("RT Bootstrapåˆ†æ...")
  rt_bootstrap <- combined_bootstrap_analysis(rt_shape_cohens, rt_label_cohens, B = 5000)
  rt_plot <- create_bootstrap_plot(rt_bootstrap, "RT")
  
  # ACCåˆ†æ  
  print("\nç¬¬äºŒæ­¥ï¼šå‡†ç¡®ç‡åˆ†æ")
  print("å¤„ç†ACC Shapeæ•°æ®...")
  acc_shape_data <- process_data(data_filtered, "Shape")
  print("å¤„ç†ACC Labelæ•°æ®...")
  acc_label_data <- process_data(data_filtered, "Label")
  
  print("è®¡ç®—ACC Cohen's d...")
  acc_shape_cohens <- calculate_cohens_d(acc_shape_data, "Shape", "ACC")
  acc_label_cohens <- calculate_cohens_d(acc_label_data, "Label", "ACC")
  
  print("ACC Bootstrapåˆ†æ...")
  acc_bootstrap <- combined_bootstrap_analysis(acc_shape_cohens, acc_label_cohens, B = 5000)
  acc_plot <- create_bootstrap_plot(acc_bootstrap, "ACC")
  
  # æ˜¾ç¤ºå›¾å½¢
  print("\nç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤ºç»“æœ")
  if(!is.null(rt_plot)) {
    print("ååº”æ—¶é—´å›¾:")
    print(rt_plot)
  } else {
    print("RTå›¾ç”Ÿæˆå¤±è´¥")
  }
  
  if(!is.null(acc_plot)) {
    print("å‡†ç¡®ç‡å›¾:")
    print(acc_plot)
  } else {
    print("ACCå›¾ç”Ÿæˆå¤±è´¥")
  }
  
  # ä¿å­˜å›¾å½¢
  if(save_plots) {
    if(!is.null(rt_plot)) {
      ggsave("Bootstrap_RT_Analysis.pdf", rt_plot, width = 20, height = 10, device = "pdf")
      print("RTå›¾å·²ä¿å­˜ä¸ºPDF")
    }
    if(!is.null(acc_plot)) {
      ggsave("Bootstrap_ACC_Analysis.pdf", acc_plot, width = 20, height = 10, device = "pdf")
      print("ACCå›¾å·²ä¿å­˜ä¸ºPDF")
    }
  }
  
  # ç»“æœæ€»ç»“
  print("\n=== åˆ†æå®Œæˆ ===")
  if(!is.na(rt_shape_cohens$mean_cohens_d)) print(paste("RT Shape Cohen's då¹³å‡å€¼:", round(rt_shape_cohens$mean_cohens_d, 4)))
  if(!is.na(rt_label_cohens$mean_cohens_d)) print(paste("RT Label Cohen's då¹³å‡å€¼:", round(rt_label_cohens$mean_cohens_d, 4)))
  if(!is.na(acc_shape_cohens$mean_cohens_d)) print(paste("ACC Shape Cohen's då¹³å‡å€¼:", round(acc_shape_cohens$mean_cohens_d, 4)))
  if(!is.na(acc_label_cohens$mean_cohens_d)) print(paste("ACC Label Cohen's då¹³å‡å€¼:", round(acc_label_cohens$mean_cohens_d, 4)))
  
  return(list(
    rt_plot = rt_plot,
    acc_plot = acc_plot,
    rt_bootstrap = rt_bootstrap,
    acc_bootstrap = acc_bootstrap,
    rt_shape_cohens = rt_shape_cohens,
    rt_label_cohens = rt_label_cohens,
    acc_shape_cohens = acc_shape_cohens,
    acc_label_cohens = acc_label_cohens
  ))
}

# =============================================================================
# æ•°æ®é¢„å¤„ç†å’Œè¿è¡Œ
# =============================================================================

# æ•°æ®é¢„å¤„ç†
data_mis <- filter(data_filtered, Matching == 'Nonmatching', RT_ms >= 200, RT_ms <= 5000)
data_RT_mis <- filter(data_mis, ACC == 1)

# è¿è¡Œå®Œæ•´åˆ†æ
print("å¼€å§‹è¿è¡Œåˆ†æ...")
results <- run_complete_analysis(data_mis, data_RT_mis)
```

